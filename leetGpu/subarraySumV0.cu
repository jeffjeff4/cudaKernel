
#include <cuda_runtime.h>

#define WARP_SIZE       32
#define THEADPERBLOCK   (WARP_SIZE*WARP_SIZE)
#define STRIDE_LENGTH   8

__device__ __forceinline__ int warp_sum(int val) {
    // å¾—åˆ°å¤„äºæ´»è·ƒçŠ¶æ€çš„çº¿ç¨‹æ©ç 
    unsigned m = __activemask();
    val += __shfl_down_sync(m , val , 16);
    val += __shfl_down_sync(m , val , 8);
    val += __shfl_down_sync(m , val , 4);
    val += __shfl_down_sync(m , val , 2);
    val += __shfl_down_sync(m , val , 1);
    return val;
}

__global__ void subarray_1D_sum_kernel(const int* __restrict__ input, int* __restrict__ output, int N) {
    /* 0.æ¯ä¸ªçº¿ç¨‹è¯»å– STRIDE_LENGTHä¸ªå…ƒç´ å¹¶æ±‚å’Œ,æ¯ä¸ªå…ƒç´ åœ¨ inputä¸­é—´éš” THEADPERBLOCK
       ä»¥ä¿è¯æ¯ä¸ªå—è¯»å–è¿ç»­ THEADPERBLOCKï¼Œåˆå¹¶å†…å­˜è®¿é—® */
    int tid = threadIdx.x;
    int offset = blockIdx.x * blockDim.x;

    int sum_val = 0;
    for (int i=0; i<STRIDE_LENGTH; ++i) {
        // æ¯”å¦‚,0å·çº¿ç¨‹è¯»å–çš„å°±æ˜¯å— 0ã€å— 1ã€...å—STRIDE_LENGTH-1çš„ 0å·ä½ç½®å…ƒç´ 
        int idx = offset*STRIDE_LENGTH + tid + i*blockDim.x;
        if (idx < N) {
            sum_val += input[idx];
        }
    }
    // ä¸‹è¿°åŒæ­¥ç‚¹éœ€è¦ä¿ç•™,warpè§„çº¦æ“ä½œåœ¨æ‰€æœ‰çº¿ç¨‹å®Œæˆæ•°æ®åŠ è½½å’Œç´¯åŠ åæ‰å¼€å§‹
    __syncthreads();

    // 1.åœ¨æ¯ä¸ª warpå†…è§„çº¦æ±‚å’Œï¼Œå¹¶å°†å…¶éƒ¨åˆ†æ±‚å’Œç»“æœå­˜å‚¨åˆ°å…±äº«å†…å­˜ä¸­
    __shared__ int shared_partial_sum[WARP_SIZE];
    int warp = tid >> 5;    // å½“å‰çº¿ç¨‹æ‰€åœ¨çš„ warpåœ¨æ•´ä¸ª warpæ•°ç»„ä¸­çš„ä¸‹æ ‡
    int lane = tid & 31;    // å½“å‰çº¿ç¨‹åœ¨å½“å‰ warpå†…çš„ä¸‹æ ‡

    int wsum = warp_sum(sum_val);
    if (lane == 0) {
        shared_partial_sum[warp] = wsum;
    }
    __syncthreads();

    // 2.å°†æ¯ä¸ªå—å†…æ‰€æœ‰ warpå·²å¾—åˆ°çš„éƒ¨åˆ†æ±‚å’Œç»“æœå†è¿›è¡Œè§„çº¦æ±‚å’Œ
    if (warp == 0) {
        float partial_sum_val = shared_partial_sum[lane];
        shared_partial_sum[0] = warp_sum(partial_sum_val);
    }
     __syncthreads();

    // 3.åˆ©ç”¨åŸå­åŠ æ“ä½œ,å¯¹æ‰€æœ‰å—å†…çš„ shared_partial_sum[0]æ±‚å’Œ
    if (tid == 0) {
        atomicAdd(output, shared_partial_sum[0]);
    }
}

// input, output are device pointers (i.e. pointers to memory on the GPU)
extern "C" void solve(const int* input, int* output, int N, int S, int E) {
    int threadsPerBlock = THEADPERBLOCK;
    // æ¯ä¸ªå—å¤„ç†çš„æ•°æ®ä¸ªæ•°
    int elementsPerBlock = threadsPerBlock*STRIDE_LENGTH;
    int n = E-S+1;
    int blocksPerGrid = (n + (elementsPerBlock - 1)) / elementsPerBlock;

    // ç¡®ä¿outputåˆå§‹åŒ–ä¸º0
    cudaMemset(output, 0, sizeof(float));
    
    subarray_1D_sum_kernel<<<blocksPerGrid, threadsPerBlock>>>(input+S, output, n);
    cudaDeviceSynchronize();
}




//--------------------------------------------------------------------------------------------------
/*
question0:
ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„ **å¹¶è¡Œæ±‚å’Œï¼ˆParallel Summationï¼‰** ç®—æ³•ï¼Œç”¨äºè®¡ç®—æ•°ç»„ä¸­ä¸€ä¸ªç‰¹å®šå­æ•°ç»„çš„æ€»å’Œã€‚å®ƒåˆ©ç”¨äº† **Warp Shuffle å½’çº¦** å’Œ **Shared Memory å½’çº¦** çš„ä¸¤çº§æœºåˆ¶æ¥åŠ é€Ÿæ±‚å’Œè¿‡ç¨‹ã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡å’Œåˆ†å·¥æœºåˆ¶

### 1\. ç›®æ ‡

è®¡ç®— input æ•°ç»„ï¼ˆå®é™…æ˜¯ A[S ... E] å­æ•°ç»„ï¼‰ä¸­æ‰€æœ‰å…ƒç´ çš„æ€»å’Œã€‚

### 2\. å®å®šä¹‰å’Œåˆ†å·¥

| å® | å€¼ | å«ä¹‰ |
| :--- | :--- | :--- |
| WARP_SIZE | 32 | Warp çº¿ç¨‹æ•°ã€‚ |
| THEADPERBLOCK | 32 * 32 = 1024 | æ¯ä¸ªçº¿ç¨‹å—çš„æ€»çº¿ç¨‹æ•°ã€‚ |
| STRIDE_LENGTH | 8 | æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•°é‡ï¼ˆå±€éƒ¨å·¥ä½œé‡ï¼‰ã€‚ |

  * **æ¯ä¸ª Block çš„å·¥ä½œé‡:** THEADPERBLOCK * STRIDE_LENGTH = 1024 * 8 = 8192 ä¸ªå…ƒç´ ã€‚

-----

## ğŸš€ II. Kernel å†…éƒ¨æµç¨‹ (`subarray_1D_sum_kernel`)

### 1\. çº¿ç¨‹èº«ä»½

```c
int tid = threadIdx.x; // 0 åˆ° 1023
int offset = blockIdx.x * blockDim.x; // Block çš„çº¿ç¨‹ ID åç§»
```

### 2\. å±€éƒ¨æ•°æ®åŠ è½½å’Œç´¯åŠ 

```c
for (int i=0; i<STRIDE_LENGTH; ++i) 
    int idx = offset*STRIDE_LENGTH + tid + i*blockDim.x;
    if (idx < N) 
        sum_val += input[idx];
    

```

  * **ç›®æ ‡:** è®©æ¯ä¸ªçº¿ç¨‹ (tid) ç‹¬ç«‹åœ°å¤„ç† STRIDE_LENGTH=8 ä¸ªå…ƒç´ ï¼Œå¹¶è®¡ç®—å±€éƒ¨å’Œ sum_valã€‚
  * **ç´¢å¼•è®¡ç®— (idx):**
      * **offset * STRIDE_LENGTH:** è®¡ç®—å½“å‰ Block è´Ÿè´£çš„ **è¿ç»­æ•°æ®å—** çš„å…¨å±€èµ·å§‹ä½ç½®ï¼ˆæœ€ä¸»è¦çš„åç§»ï¼‰ã€‚
      * **+ tid:** çº¿ç¨‹ tid åœ¨è¿™ä¸ªå¤§å—ä¸­çš„èµ·å§‹åç§»ã€‚
      * **+ i * blockDim.x:** **äº¤é”™è®¿é—®æ­¥é•¿ã€‚** ç¡®ä¿çº¿ç¨‹ tid åœ¨æ¯æ¬¡å¾ªç¯ä¸­è¯»å–çš„æ•°æ®ï¼Œä¸çº¿ç¨‹ tid+1 è¯»å–çš„æ•°æ®ç›¸éš” **1024 ä¸ªå…ƒç´ **ã€‚
  * **ç¤ºä¾‹ (Block 0):** offset=0
      * çº¿ç¨‹ 0 (tid=0): è¯»å–ç´¢å¼• 0, 1024, 2048, ..., 7168 çš„ 8 ä¸ªå…ƒç´ ã€‚
      * çº¿ç¨‹ 1 (tid=1): è¯»å–ç´¢å¼• 1, 1025, 2049, ..., 7169 çš„ 8 ä¸ªå…ƒç´ ã€‚
  * **ç›®çš„:** è¿™ç§æ­¥é•¿ blockDim.x çš„äº¤é”™è¯»å–ï¼Œæ˜¯ä¸ºäº†åœ¨ A çŸ©é˜µçš„ N ç»´åº¦ä¸Šå®ç°**å†…å­˜åˆå¹¶ (Coalescing)**ï¼Œå› ä¸ºç›¸é‚»çº¿ç¨‹è®¿é—®çš„æ•°æ®æ˜¯è¿ç»­çš„ã€‚

### 3\. ç¬¬ä¸€çº§å½’çº¦ï¼šWarp å†…éƒ¨æ±‚å’Œ (Shuffle)

```c
__shared__ int shared_partial_sum[WARP_SIZE]; // é•¿åº¦ 32
int warp = tid >> 5;    // Warp ID (0 to 31)
int lane = tid & 31;    // Lane ID (0 to 31)

int wsum = warp_sum(sum_val); // Shuffle å½’çº¦
if (lane == 0) 
    shared_partial_sum[warp] = wsum;

__syncthreads();
```

  * **Warp å½’çº¦:** `warp_sum` å‡½æ•°ä½¿ç”¨ Shuffle æŒ‡ä»¤å°†æ¯ä¸ª Warp çš„ 32 ä¸ª sum_val ç´¯åŠ èµ·æ¥ï¼Œç»“æœå­˜å‚¨åœ¨ lane=0 çš„çº¿ç¨‹çš„ wsum ä¸­ã€‚
  * **Shared Memory å­˜å‚¨:** 1024 ä¸ªçº¿ç¨‹è¢«åˆ†ä¸º 32 ä¸ª Warpã€‚æ¯ä¸ª Warp çš„ lane=0 çº¿ç¨‹å°†å…¶ Warp çš„æ€»å’Œå†™å…¥ shared_partial_sum[warp] æ•°ç»„ã€‚

### 4\. ç¬¬äºŒçº§å½’çº¦ï¼šBlock å†…éƒ¨æ±‚å’Œ (Shared Memory)

```c
if (warp == 0)  // åªæœ‰ Warp 0 è¿›è¡Œå½’çº¦
    float partial_sum_val = shared_partial_sum[lane]; // Warp 0 çš„çº¿ç¨‹è¯»å– 32 ä¸ªå±€éƒ¨å’Œ
    shared_partial_sum[0] = warp_sum(partial_sum_val); // å†æ¬¡ Shuffle å½’çº¦

__syncthreads();
```

  * **æ•°æ®æ”¶é›†:** Warp 0 çš„ 32 ä¸ªçº¿ç¨‹è¯»å– shared_partial_sum æ•°ç»„ä¸­çš„ 32 ä¸ª Warp æ€»å’Œã€‚
  * **äºŒæ¬¡å½’çº¦:** Warp 0 å†æ¬¡ä½¿ç”¨ `warp_sum` å¯¹è¿™ 32 ä¸ªå€¼è¿›è¡Œå½’çº¦ã€‚
  * **ç»“æœ:** æ•´ä¸ªçº¿ç¨‹å—çš„æ€»å’Œç°åœ¨å­˜å‚¨åœ¨ shared_partial_sum[0] ä¸­ã€‚

### 5\. æœ€ç»ˆåŸå­ç´¯åŠ 

```c
if (tid == 0) 
    atomicAdd(output, shared_partial_sum[0]);

```

  * åªæœ‰ Block å†…çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ (tid=0) å°†æ•´ä¸ª Block çš„æœ€ç»ˆæ€»å’Œå®‰å…¨åœ°ç´¯åŠ åˆ°å…¨å±€çš„ output å˜é‡ä¸­ã€‚

-----

## ğŸ’» III. ä¸»æœºç«¯æ±‚è§£ (`solve` å‡½æ•°)

`solve` å‡½æ•°è´Ÿè´£è®¾ç½® Grid å°ºå¯¸ï¼Œå¹¶å¤„ç†å­æ•°ç»„çš„èµ·å§‹åœ°å€ã€‚

```c
// ...
// n æ˜¯å­æ•°ç»„çš„å®é™…é•¿åº¦ (E - S + 1)
int elementsPerBlock = threadsPerBlock*STRIDE_LENGTH; // 8192
int blocksPerGrid = (n + (elementsPerBlock - 1)) / elementsPerBlock; // å‘ä¸Šå–æ•´
// ...
subarray_1D_sum_kernel<<<blocksPerGrid, threadsPerBlock>>>(input+S, output, n);
```

  * **å­æ•°ç»„å¤„ç†:** `input+S` å°†è¾“å…¥æŒ‡é’ˆåç§»åˆ°å­æ•°ç»„çš„èµ·å§‹ç‚¹ Sã€‚`n = E - S + 1` ç¡®ä¿ Kernel å†…éƒ¨çš„è¾¹ç•Œæ£€æŸ¥ä½¿ç”¨æ­£ç¡®çš„å­æ•°ç»„é•¿åº¦ã€‚

**æ€»ç»“:** è¿™ä¸ª Kernel å®ç°äº†é«˜æ•ˆçš„ **ä¸‰çº§å¹¶è¡Œæ±‚å’Œ** (\textThread Local --> \textWarp Shuffle --> \textShared/Shuffle --> \textAtomic) æ¥è®¡ç®—å­æ•°ç»„çš„æ€»å’Œã€‚


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question1:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­, ç‰¹åˆ«æ˜¯
        int idx = offset*STRIDE_LENGTH + tid + i*blockDim.x;

    int sum_val = 0;
    for (int i=0; i<STRIDE_LENGTH; ++i) 
        // æ¯”å¦‚,0å·çº¿ç¨‹è¯»å–çš„å°±æ˜¯å— 0ã€å— 1ã€...å—STRIDE_LENGTH-1çš„ 0å·ä½ç½®å…ƒç´ 
        int idx = offset*STRIDE_LENGTH + tid + i*blockDim.x;
        ...
    

answer:
è¿™æ®µä»£ç æ˜¯ **å¹¶è¡Œæ±‚å’Œ Kernel** ä¸­æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®ƒå®šä¹‰äº†çº¿ç¨‹å—ï¼ˆBlockï¼‰å¦‚ä½•åä½œï¼Œå°†å¤§è§„æ¨¡æ•°æ®ä»å…¨å±€å†…å­˜ï¼ˆGlobal Memoryï¼‰è¯»å–åˆ°çº¿ç¨‹çš„ç§æœ‰å¯„å­˜å™¨ä¸­ï¼Œå¹¶è¿›è¡Œå±€éƒ¨ç´¯åŠ ã€‚

è¿™ç§ç´¢å¼•æ¨¡å¼è¢«ç§°ä¸º **Block-Interleaved/Block-Cyclic** æˆ– **CUDA-Optimized Stride Access**ï¼Œæ—¨åœ¨å®ç°æœ€é«˜æ•ˆçš„å†…å­˜è®¿é—®ã€‚

---

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡ï¼šäº¤é”™è¯»å–ä¸å†…å­˜åˆå¹¶

* **ç›®çš„:** è®©ç›¸é‚»çš„çº¿ç¨‹ï¼ˆåœ¨åŒä¸€ä¸ª Warp å†…ï¼‰è¯»å–å†…å­˜ä¸­**è¿ç»­çš„**æ•°æ®ï¼Œä»¥å®ç° **å†…å­˜åˆå¹¶ (Coalescing)**ï¼Œä»è€Œæœ€å¤§åŒ– Global Memory å¸¦å®½ã€‚
* **æ–¹æ³•:** æ¯ä¸ªçº¿ç¨‹ (tid) è´Ÿè´£å¤„ç† STRIDE_LENGTH=8 ä¸ªå…ƒç´ ã€‚è¿™ 8 æ¬¡è¯»å–é€šè¿‡ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æ­¥é•¿ (i * blockDim.x) ä¿è¯äº†æ•°æ®çš„è¿ç»­æ€§ã€‚

## ğŸ”¢ II. ç¤ºä¾‹å‚æ•°è®¾å®š

æˆ‘ä»¬ä½¿ç”¨ Kernel ä¸­çš„å‚æ•°å’Œç®€åŒ–å€¼ï¼š

* blockDim.x (çº¿ç¨‹æ•°) = 1024
* STRIDE_LENGTH (å¾ªç¯æ¬¡æ•°) = 8
* N (æ€»å…ƒç´ æ•°) = 10000

### 1. K ç»´åº¦ä¸»åç§»é‡ (offset)

offset = blockIdx.x * blockDim.x

* **å«ä¹‰:** çº¿ç¨‹å—çš„ ID ä¹˜ä»¥çº¿ç¨‹æ•°ã€‚
    * å‡è®¾ blockIdx.x = 1ã€‚offset = 1 * 1024 = 1024ã€‚

### 2. Block æ•°æ®çš„å…¨å±€èµ·å§‹ç´¢å¼•

Block\ Start = offset * STRIDE_LENGTH

* **å«ä¹‰:** å½“å‰çº¿ç¨‹å—è´Ÿè´£çš„æ•°æ®åŒºåŸŸçš„èµ·å§‹ç´¢å¼•ã€‚
* **ç¤ºä¾‹:** Block\ Start = 1024 * 8 = 8192ã€‚

---

## ğŸš€ III. ç´¢å¼• idx çš„è®¡ç®—ä¸åˆ†å·¥

idx = offset * STRIDE_LENGTH + tid + i * blockDim.x

æˆ‘ä»¬å°†è·Ÿè¸ª **Warp 0** çš„å‰ä¸¤ä¸ªçº¿ç¨‹ï¼ˆtid=0, 1ï¼‰æ¥å±•ç¤ºäº¤é”™è¯»å–å’Œè¿ç»­æ€§ã€‚

### A. çº¿ç¨‹ tid=0 (çº¿ç¨‹ 0)

| å¾ªç¯ i | i * blockDim.x | idx = 8192 + 0 + i * 1024 | å«ä¹‰ (è¯»å–åœ°å€) |
| :--- | :--- | :--- | :--- |
| **0** | 0 | 8192 | çº¿ç¨‹ 0 è¯»å– Block æ•°æ®çš„ **ç¬¬ 0 ä¸ª** å…ƒç´ ã€‚ |
| **1** | 1024 | 9216 | çº¿ç¨‹ 0 è¯»å– Block æ•°æ®çš„ **ç¬¬ 1024 ä¸ª** å…ƒç´ ã€‚ |
| **7** | 7168 | 15360 | çº¿ç¨‹ 0 è¯»å– Block æ•°æ®çš„ **ç¬¬ 7168 ä¸ª** å…ƒç´ ã€‚ |
| **æ€»è®¡:** | | | **çº¿ç¨‹ 0 è¯»å–äº† 8 ä¸ªåˆ†æ•£çš„å…ƒç´ ** |

### B. çº¿ç¨‹ tid=1 (çº¿ç¨‹ 1)

| å¾ªç¯ i | i * blockDim.x | idx = 8192 + 1 + i * 1024 | å«ä¹‰ (è¯»å–åœ°å€) |
| :--- | :--- | :--- | :--- |
| **0** | 0 | 8193 | çº¿ç¨‹ 1 è¯»å– Block æ•°æ®çš„ **ç¬¬ 1 ä¸ª** å…ƒç´ ã€‚ |
| **1** | 1024 | 9217 | çº¿ç¨‹ 1 è¯»å– Block æ•°æ®çš„ **ç¬¬ 1025 ä¸ª** å…ƒç´ ã€‚ |
| **7** | 7168 | 15361 | çº¿ç¨‹ 1 è¯»å– Block æ•°æ®çš„ **ç¬¬ 7169 ä¸ª** å…ƒç´ ã€‚ |
| **æ€»è®¡:** | | | **çº¿ç¨‹ 1 è¯»å–äº† 8 ä¸ªåˆ†æ•£çš„å…ƒç´ ** |

## ğŸ¯ IV. ç»“è®ºï¼šä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

### 1. å†…å­˜åˆå¹¶ (Coalescing) çš„ä¿è¯

è™½ç„¶çº¿ç¨‹ 0 è¯»å–çš„åœ°å€æ˜¯åˆ†æ•£çš„ï¼ˆ8192, 9216, 15360ï¼‰ï¼Œä½†æˆ‘ä»¬çœ‹ **åŒä¸€æ—¶é—´ (i å¾ªç¯ä¸å˜)** æ‰€æœ‰çº¿ç¨‹çš„è¯»å–åœ°å€ï¼š

* å½“ i=0 æ—¶ï¼š
    * çº¿ç¨‹ 0 è¯»å– 8192
    * çº¿ç¨‹ 1 è¯»å– 8193
    * çº¿ç¨‹ 2 è¯»å– 8194
    * ...
    * çº¿ç¨‹ 31 è¯»å– 8223
* **ç»“æœ:** Warp 0 ä¸­çš„ 32 ä¸ªçº¿ç¨‹è¯»å–äº†ä» 8192 åˆ° 8223 çš„ **è¿ç»­ 32 ä¸ªå…ƒç´ **ã€‚

**ç»“è®º:** è¿™ç§ç´¢å¼•ç»“æ„ç¡®ä¿äº†åœ¨ i å¾ªç¯çš„**æ¯ä¸€æ¬¡è¿­ä»£ä¸­**ï¼Œæ•´ä¸ª Warp éƒ½èƒ½æ‰§è¡Œä¸€æ¬¡**å®Œç¾åˆå¹¶çš„å†…å­˜è®¿é—®**ï¼Œè¿™æ˜¯æœ€å¤§åŒ– Global Memory ååé‡çš„å…³é”®ã€‚

### 2. çº¿ç¨‹åˆ†å·¥çš„ä¿è¯

* **tid:** è´Ÿè´£å¤„ç† **å‚ç›´** ç»´åº¦ä¸Šçš„å…ƒç´ ã€‚
* **i * blockDim.x:** è´Ÿè´£å¤„ç† **æ°´å¹³** ç»´åº¦ä¸Šçš„å…ƒç´ ã€‚

æ•´ä¸ªçº¿ç¨‹å—è´Ÿè´£ 1024 * 8 = 8192 ä¸ªå…ƒç´ ã€‚æ¯ä¸ªçº¿ç¨‹è´Ÿè´£ 8 ä¸ªå…ƒç´ ï¼Œå¹¶ä»¥ blockDim.x (1024) ä¸ºæ­¥é•¿äº¤é”™è¯»å–ï¼Œä¿è¯äº†æ‰€æœ‰æ•°æ®éƒ½è¢«é«˜æ•ˆè¦†ç›–ã€‚

//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question2:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

__device__ __forceinline__ int warp_sum(int val) 
    // å¾—åˆ°å¤„äºæ´»è·ƒçŠ¶æ€çš„çº¿ç¨‹æ©ç 
    unsigned m = __activemask();
    val += __shfl_down_sync(m , val , 16);
    val += __shfl_down_sync(m , val , 8);
    val += __shfl_down_sync(m , val , 4);
    val += __shfl_down_sync(m , val , 2);
    val += __shfl_down_sync(m , val , 1);
    return val;


answer:
è¿™æ®µä»£ç æ˜¯ CUDA ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªç»å…¸ä¼˜åŒ–æŠ€å·§ï¼Œç”¨äºåœ¨ **Warpï¼ˆçº¿ç¨‹æŸï¼‰** å†…éƒ¨è¿›è¡Œ**å¹¶è¡Œæ±‚å’Œå½’çº¦ (Parallel Reduction)**ã€‚å®ƒåˆ©ç”¨ **Warp Shuffle æŒ‡ä»¤** (__shfl_down_sync) æ¥å®ç°æå¿«çš„ç´¯åŠ ï¼Œå› ä¸ºå®ƒé¿å…äº†æ…¢é€Ÿçš„å…±äº«å†…å­˜è®¿é—®å’Œå…¨å±€åŒæ­¥ã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡ï¼šWarp å†…éƒ¨æ±‚å’Œ

  * **ç›®æ ‡:** å°† Warp ä¸­æ‰€æœ‰ 32 ä¸ªçº¿ç¨‹çš„ç§æœ‰å˜é‡ val ç´¯åŠ èµ·æ¥ï¼Œå¹¶å°†æœ€ç»ˆçš„æ€»å’Œå­˜å‚¨åœ¨ Warp å†…çš„**æ‰€æœ‰çº¿ç¨‹**çš„ val å˜é‡ä¸­ï¼ˆæˆ–é€šå¸¸åªå…³å¿ƒçº¿ç¨‹ 0 çš„ç»“æœï¼‰ã€‚
  * **æœºåˆ¶:** __shfl_down_sync å…è®¸çº¿ç¨‹ç›´æ¥ä» Warp å†…çš„å¦ä¸€ä¸ªçº¿ç¨‹çš„å¯„å­˜å™¨ä¸­è¯»å–æ•°æ®ã€‚

## ğŸ”¢ II. ç¤ºä¾‹å‚æ•°å’ŒæŒ‡ä»¤åˆ†è§£

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Warp (32 ä¸ªçº¿ç¨‹)ï¼Œåˆå§‹ val å¦‚ä¸‹ï¼š

| çº¿ç¨‹ ID (lane) | 0 | 1 | 2 | 3 | ... | 16 | 17 | ... | 31 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **åˆå§‹ val** | v_0 | v_1 | v_2 | v_3 | ... | v_16 | v_17 | ... | v_31 |

### 1\. æ´»è·ƒçº¿ç¨‹æ©ç  (__activemask())

```c
unsigned m = __activemask();
```

  * **ç›®çš„:** è·å–å½“å‰ Warp ä¸­æ‰€æœ‰ **æ´»è·ƒçº¿ç¨‹** çš„ä½æ©ç ã€‚
  * **ä½œç”¨:** å°†è¿™ä¸ªæ©ç  (m) ä¼ é€’ç»™ __shfl_down_syncï¼Œç¡®ä¿æ•°æ®äº¤æ¢åªå‘ç”Ÿåœ¨é‚£äº›å½“å‰æ­£åœ¨æ‰§è¡Œä»£ç çš„çº¿ç¨‹ä¹‹é—´ï¼Œé¿å…æ­»é”æˆ–é”™è¯¯ã€‚

### 2\. æ ‘å½¢å½’çº¦ (Tree Reduction)

å¾ªç¯æ‰§è¡Œ 5 æ¬¡ (16 --> 8 --> 4 --> 2 --> 1)ï¼Œè¿™æ˜¯ \log_2(32) = 5 æ­¥ã€‚

#### æ­¥éª¤ 1: delta = 16

```c
val += __shfl_down_sync(m , val , 16);
```

  * **æ“ä½œ:** æ¯ä¸ªçº¿ç¨‹ tx ä»çº¿ç¨‹ tx + 16 çš„å¯„å­˜å™¨ä¸­è¯»å–æ•°æ®ã€‚
  * **ç¤ºä¾‹ (çº¿ç¨‹ 0):** çº¿ç¨‹ 0 è¯»å– v_16ã€‚ v_0 <-- v_0 + v_16ã€‚
  * **ç¤ºä¾‹ (çº¿ç¨‹ 16):** çº¿ç¨‹ 16 è¯»å– v_32ï¼ˆä¸å­˜åœ¨ï¼Œè¯»å–è‡ªå·±ï¼‰ã€‚ v_16 <-- v_16 + v_32ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚
  * **ç»“æœ:** æ•°æ®å®Œæˆäº†ç¬¬ä¸€å±‚å‡åŠæ±‚å’Œã€‚

#### æ­¥éª¤ 2: delta = 8

```c
val += __shfl_down_sync(m , val , 8);
```

  * **æ“ä½œ:** æ¯ä¸ªçº¿ç¨‹ tx ä»çº¿ç¨‹ tx + 8 å¤„è¯»å–æ•°æ®ã€‚
  * **ç¤ºä¾‹ (çº¿ç¨‹ 0):** çº¿ç¨‹ 0 è¯»å– v_8ï¼ˆå·²åŒ…å« v_24ï¼‰ã€‚ v_0 <-- v_0 + (v_8 + v_24)ã€‚
  * **ç»“æœ:** æ•°æ®ç»§ç»­å‡åŠæ±‚å’Œã€‚

#### æœ€ç»ˆæ­¥éª¤: delta = 1

```c
val += __shfl_down_sync(m , val , 1);
```

  * **æ“ä½œ:** çº¿ç¨‹ 0 ä»çº¿ç¨‹ 1 å¤„è¯»å–æ•°æ®ã€‚
  * **ç»“æœ:** æœ€ç»ˆçš„æ€»å’Œç´¯ç§¯åœ¨ lane=0 çš„çº¿ç¨‹ä¸­ã€‚

## ğŸ¯ æ€»ç»“

è¿™ä¸ª `warp_sum` å‡½æ•°çš„ä¼˜åŠ¿åœ¨äºï¼š

1.  **é€Ÿåº¦:** æ•´ä¸ªæ±‚å’Œè¿‡ç¨‹åœ¨ 5 ä¸ªæŒ‡ä»¤æ­¥ä¸­å®Œæˆï¼Œæ²¡æœ‰å†…å­˜è®¿é—®ã€‚
2.  **ç»“æœåˆ†å¸ƒ:** æœ€ç»ˆçš„æ€»å’Œ \sum v_i å­˜å‚¨åœ¨ **æ‰€æœ‰** çº¿ç¨‹çš„ val å˜é‡ä¸­ï¼ˆå› ä¸ºæ¯æ¬¡åŠ æ³•éƒ½æ›´æ–°äº†æ‰€æœ‰çº¿ç¨‹çš„ valï¼‰ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åªä½¿ç”¨ lane=0 çº¿ç¨‹çš„æœ€ç»ˆç»“æœã€‚

è¿™ä¸ªå‡½æ•°æ˜¯å¹¶è¡Œæ±‚å’Œã€å½’çº¦ä»¥åŠæ•°æ®å¹¿æ’­çš„åŸºç¡€å·¥å…·ã€‚

//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question3:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­




//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question4:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­



//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question5:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­


//--------------------------------------------------------------------------------------------------




//--------------------------------------------------------------------------------------------------
/*
question6:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œæœ‰ä¾‹å­




//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question7:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­




//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question8:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question10:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question11:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question12:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question13:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question14:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question15:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question16:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question17:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question18:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question19:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question20:


//--------------------------------------------------------------------------------------------------
