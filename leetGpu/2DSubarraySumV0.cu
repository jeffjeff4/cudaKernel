
#include <cuda_runtime.h>

#define TILE_X 32
#define TILE_Y 32
#define CFACTOR 8
__global__ void subarray_sum_2d(const int* input, int* output, int N, int M, int S_ROW, 
                            int E_ROW, int S_COL, int E_COL){
    int col = threadIdx.x + CFACTOR * blockDim.x * blockIdx.x;
    int row = threadIdx.y + CFACTOR * blockDim.y * blockIdx.y;
    
    __shared__ int Ms[TILE_X * TILE_Y];

    int v = 0;
    for(int i = 0; i < CFACTOR; i++){
        int row1 = row + i * blockDim.y;
        for(int j = 0; j < CFACTOR; j++){
            int col1 = col + j * blockDim.x;
            if(S_ROW <= row1 && row1 <= E_ROW && S_COL <= col1 && col1 <= E_COL){
                v += input[row1 * M + col1];
            }
        }
    }
    Ms[threadIdx.y * TILE_X + threadIdx.x] = v;
    __syncthreads();

    int p = threadIdx.y * TILE_X + threadIdx.x;
    for(int j = TILE_X * TILE_Y / 2; j > 0; j >>= 1){
        if(p < j){
            Ms[p] += Ms[p + j];
        }
        __syncthreads();
    }

    if(p == 0){
        atomicAdd(output, Ms[0]);
    }
}


// input, output are device pointers (i.e. pointers to memory on the GPU)
extern "C" void solve(const int* input, int* output, int N, int M, int S_ROW, int E_ROW, int S_COL, int E_COL) {
    dim3 threadsPerBlock(TILE_Y, TILE_X);
    dim3 blocksPerGrid(
        (N + CFACTOR * TILE_Y - 1) / (CFACTOR * TILE_Y),
        (M + CFACTOR * TILE_X - 1) / (CFACTOR * TILE_X)
    );

    subarray_sum_2d<<<blocksPerGrid, threadsPerBlock>>>(
        input, output, N, M, S_ROW, E_ROW, S_COL, E_COL
    );

}



//--------------------------------------------------------------------------------------------------
/*
question0:
‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê

ËøôÊÆµ CUDA ‰ª£Á†ÅÂÆûÁé∞‰∫Ü‰∏Ä‰∏™È´òÊïàÁöÑ **Âπ∂Ë°åÂ≠êÊï∞ÁªÑÊ±ÇÂíåÔºàParallel Subarray SummationÔºâ** ÁÆóÊ≥ïÔºåÁî®‰∫éËÆ°ÁÆó‰∏Ä‰∏™Â§ßÂûã‰∫åÁª¥Áü©Èòµ‰∏≠**ÊåáÂÆöÁü©ÂΩ¢Âå∫Âüü**ÂÜÖÊâÄÊúâÂÖÉÁ¥†ÁöÑÊÄªÂíå„ÄÇ

ÂÆÉ‰ΩøÁî®‰∫ÜÁªèÂÖ∏ÁöÑ **Shared Memory ÂΩíÁ∫¶ (Reduction)** Âíå **Âçè‰ΩúÂºè Block-Stride Loop** ÊäÄÊúØ„ÄÇ

-----

## ‚öôÔ∏è I. Ê†∏ÂøÉÁõÆÊ†áÂíåÂàÜÂ∑•Êú∫Âà∂

### 1\. ÁõÆÊ†á

ËÆ°ÁÆóÁü©Èòµ input ‰∏≠ÔºåÁî±Ëµ∑ÂßãÂùêÊ†á (S_ROW, S_COL) Âà∞ÁªìÊùüÂùêÊ†á (E_ROW, E_COL) ÂÆö‰πâÁöÑÂ≠êÁü©ÈòµÁöÑÊÄªÂíå„ÄÇ

### 2\. ÂÆèÂÆö‰πâÂíåÂàÜÂ∑•

| ÂÆè | ÂÄº | Âê´‰πâ |
| :--- | :--- | :--- |
| TILE_X, TILE_Y | 32, 32 | Á∫øÁ®ãÂùóÁöÑÁª¥Â∫¶ (blockDim) |
| CFACTOR | 8 | Á≤óÁ≤íÂ∫¶Âõ†Â≠êÔºàÊØè‰∏™Á∫øÁ®ãË¥üË¥£ÁöÑÂæ™ÁéØÊ¨°Êï∞Ôºâ |
| **ÊÄªÁ∫øÁ®ãÊï∞** | 32 * 32 = 1024 | |

  * **ÊØè‰∏™ Block Ë¥üË¥£ÁöÑÊÄªÂå∫Âüü:** 32 * 8 * 32 * 8 = 256 * 256 ÁöÑ‰∏Ä‰∏™ Tile Âå∫Âüü„ÄÇ
  * **Á∫øÁ®ãÂàÜÂ∑•:** ÊØè‰∏™Á∫øÁ®ãË¥üË¥£ËÆ°ÁÆó CFACTOR * CFACTOR = 8 * 8 = 64 ‰∏™ÂÖÉÁ¥†ÁöÑÂíåÔºàÈÄöËøá i Âíå j Âæ™ÁéØÂÆûÁé∞Ôºâ„ÄÇ

-----

## üöÄ II. Kernel ÂÜÖÈÉ®ÊµÅÁ®ã

### 1\. Á¥¢ÂºïËÆ°ÁÆó (Block-Interleaved Start)

c
int col = threadIdx.x + CFACTOR * blockDim.x * blockIdx.x;
int row = threadIdx.y + CFACTOR * blockDim.y * blockIdx.y;


  * **ÁõÆÁöÑ:** ËÆ°ÁÆóÂΩìÂâçÁ∫øÁ®ãÂú®Êï¥‰∏™Â§ßÁü©Èòµ input ‰∏≠ÁöÑ**Ëµ∑ÂßãÂùêÊ†á** (row, col)„ÄÇ
  * **ÂéüÁêÜ:**
      * threadIdx.x / threadIdx.yÔºöÁ∫øÁ®ãÂú® Block ÂÜÖÁöÑÂÅèÁßª„ÄÇ
      * CFACTOR * blockDim.x * blockIdx.xÔºöËøôÊòØ Block Á∫ßÂà´ÁöÑË∑≥Ë∑ÉÔºåÁ°Æ‰øùÊØè‰∏™ Block ‰ªéÊ≠£Á°ÆÁöÑÂ§ß Tile Ëµ∑ÂßãÁÇπÂºÄÂßã„ÄÇ

> **Á§∫‰æã:** ÂÅáËÆæ tx=5, ty=1 ‰Ωç‰∫é bx=1, by=0 ÁöÑ Block„ÄÇ
>
>   * **row** (Ë°å): 1 + 8 * 32 * 0 = 1
>   * **col** (Âàó): 5 + 8 * 32 * 1 = 5 + 256 = 261
>   * **ÁªìËÆ∫:** Á∫øÁ®ã (1, 5) ÁöÑËÆ°ÁÆó‰ªéÁü©ÈòµÁöÑ (1, 261) ‰ΩçÁΩÆÂºÄÂßã„ÄÇ

### 2\. Â±ÄÈÉ®Ê±ÇÂíå (Block-Stride Loop)

c
for(int i = 0; i < CFACTOR; i++){
    int row1 = row + i * blockDim.y;
    for(int j = 0; j < CFACTOR; j++){
        int col1 = col + j * blockDim.x;
        if(S_ROW <= row1 && row1 <= E_ROW && S_COL <= col1 && col1 <= E_COL){
            v += input[row1 * M + col1]; // Á¥ØÂä†ÊúâÊïàÂÖÉÁ¥†
        
    



  * **ÁõÆÁöÑ:** ÊØè‰∏™Á∫øÁ®ãËÆ°ÁÆóÂÆÉË¥üË¥£ÁöÑ 8 * 8 = 64 ‰∏™ÂÖÉÁ¥†‰πãÂíå v„ÄÇ
  * **Âæ™ÁéØÊ≠•Èïø:**
      * row1 = row + i * blockDim.y (32)„ÄÇ
      * col1 = col + j * blockDim.x (32)„ÄÇ
  * **‰∫§ÈîôËÆøÈóÆ:** ËøôÁ°Æ‰øù‰∫ÜÁ∫øÁ®ã tx Âíå tx+1 Âú® i=0, j=0 Êó∂ËØªÂèñÁöÑÁ¥¢ÂºïÊòØ col Âíå col+1ÔºàËøûÁª≠ÔºâÔºåÂÆûÁé∞‰∫Ü **ÂÜÖÂ≠òÂêàÂπ∂**„ÄÇ
  * **ËæπÁïåÊ£ÄÊü•:** `if (S_ROW <= row1 && ...)`ÔºöËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑÈÄªËæëÔºåÂÆÉÊ£ÄÊü•ÂΩìÂâçËÆ°ÁÆóÁöÑÂùêÊ†á (row1, col1) ÊòØÂê¶ËêΩÂú®‰∫ÜÁî®Êà∑ÊåáÂÆöÁöÑÁü©ÂΩ¢Â≠êÂå∫ÂüüÂÜÖ„ÄÇÂè™ÊúâÂú®Â≠êÂå∫ÂüüÂÜÖÁöÑÂÖÉÁ¥†Êâç‰ºöË¢´Á¥ØÂä†„ÄÇ

### 3\. Shared Memory Â≠òÂÇ®

c
__shared__ int Ms[TILE_X * TILE_Y]; // 1024 ÈïøÂ∫¶
Ms[threadIdx.y * TILE_X + threadIdx.x] = v;
__syncthreads();


  * **ÁõÆÁöÑ:** Â∞ÜÁ∫øÁ®ãÁöÑÂ±ÄÈÉ®Âíå v Â≠òÂÖ• Ms Êï∞ÁªÑ„ÄÇ
  * **Á¥¢Âºï:** ‰ΩøÁî®Ê†áÂáÜÁöÑ 2D Âà∞ 1D Êò†Â∞Ñ (ty * 32 + tx)„ÄÇ

### 4\. Block ÂÜÖÈÉ®ÂΩíÁ∫¶ (Reduction)

c
int p = threadIdx.y * TILE_X + threadIdx.x;
for(int j = TILE_X * TILE_Y / 2; j > 0; j >>= 1){
    if(p < j){
        Ms[p] += Ms[p + j];
    
    __syncthreads();



  * **ÁõÆÁöÑ:** ÂØπ Ms Êï∞ÁªÑÊâßË°åÊ†áÂáÜÁöÑ **Âπ∂Ë°åÂΩíÁ∫¶ÔºàÊ±ÇÂíåÔºâ**„ÄÇ
  * **Êú∫Âà∂:** ËøôÊòØ‰∏Ä‰∏™ÁªèÂÖ∏ÁöÑ **Ê†ëÂΩ¢ÂΩíÁ∫¶** ÁÆóÊ≥ï„ÄÇÊâÄÊúâ 1024 ‰∏™Á∫øÁ®ãÂçè‰ΩúÔºåÂ∞ÜÊâÄÊúâÂ±ÄÈÉ®ÂíåÁ¥ØÂä†Âà∞ Ms[0]„ÄÇ

### 5\. ÊúÄÁªàÂéüÂ≠êÁ¥ØÂä†

c
if(p == 0){
    atomicAdd(output, Ms[0]);



  * **ÁõÆÁöÑ:** Âè™ÊúâÁ∫øÁ®ã p=0 (Âç≥ tx=0, ty=0) Â∞ÜÊï¥‰∏™ Block ÁöÑÊúÄÁªàÊÄªÂíå Ms[0] ‰ΩøÁî® atomicAdd Á¥ØÂä†Âà∞ÂÖ®Â±ÄÁªìÊûú output ‰∏≠„ÄÇ

## üíª III. ‰∏ªÊú∫Á´ØÂêØÂä® (`solve`)

c
// ...
dim3 dimGrid(
    (N + CFACTOR * TILE_Y - 1) / (CFACTOR * TILE_Y), // Grid Y size
    (M + CFACTOR * TILE_X - 1) / (CFACTOR * TILE_X) // Grid X size
);


  * **Grid Â∞∫ÂØ∏:** Grid ÁöÑ Y ËΩ¥Ë¥üË¥£Ë¶ÜÁõñ N Áª¥Â∫¶ÔºàË°åÔºâÔºåX ËΩ¥Ë¥üË¥£Ë¶ÜÁõñ M Áª¥Â∫¶ÔºàÂàóÔºâ„ÄÇ
  * **ÂéüÁêÜ:** ‰ΩøÁî® **Âêë‰∏äÂèñÊï¥Èô§Ê≥ï** Á°Æ‰øù Grid ÂêØÂä®Ë∂≥Â§üÁöÑ Blocks Êù•Ë¶ÜÁõñ N * M Áü©ÈòµÁöÑÊâÄÊúâÈÉ®ÂàÜ„ÄÇ
      * **Èô§Êï∞:** CFACTOR * TILE_Y (Âç≥ 256) ÊòØÊØè‰∏™ Block Âú®ËØ•Áª¥Â∫¶‰∏äË¥üË¥£ÁöÑÊÄªÂÖÉÁ¥†Êï∞„ÄÇ
  * **ÂêØÂä®:** `subarray_sum_2d<<<dimGrid, threadsPerBlock>>>` ÂêØÂä® Kernel„ÄÇ

//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question1:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question2:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question3:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê




//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question4:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê



//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question5:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê


//--------------------------------------------------------------------------------------------------




//--------------------------------------------------------------------------------------------------
/*
question6:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÊúâ‰æãÂ≠ê




//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question7:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê




//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question8:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question10:

‰∏çÁêÜËß£ÔºåËØ∑Ëß£ÈáäÔºåÁî®‰æãÂ≠ê


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question11:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question12:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question13:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question14:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question15:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question16:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question17:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question18:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question19:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question20:


//--------------------------------------------------------------------------------------------------
