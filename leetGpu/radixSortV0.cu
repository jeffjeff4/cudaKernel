#include <cuda_runtime.h>
#include <stdio.h>

#define BITS 0x1
#define VSIZE 4
#define TILE_SIZE 512
#define SORT_TILE_SIZE 1024
#define WARP_SIZE 32

__global__ void radix_sort_kernel(
    const unsigned int* input, unsigned int* bits, unsigned int* prebits,
    int N, int iter
) {
    __shared__ unsigned int SHMEM[TILE_SIZE];
    unsigned int locals[VSIZE];
    int tx = threadIdx.x;
    
    int base = blockIdx.x * blockDim.x * VSIZE;
    int loc = base + tx * VSIZE;

    int Pvalue = 0;
    bool within = (loc + VSIZE) <= N;

    if (within) {
        const int4 *ptr = reinterpret_cast<const int4*>(&input[loc]);
        const int4 val = ptr[0];
        int bit0 = ((val.x >> iter) & 1);
        int bit1 = ((val.y >> iter) & 1);
        int bit2 = ((val.z >> iter) & 1);
        int bit3 = ((val.w >> iter) & 1);
        
        locals[0] = 0;
        locals[1] = bit0;
        locals[2] = bit0 + bit1;
        locals[3] = bit0 + bit1 + bit2;
        Pvalue = bit0 + bit1 + bit2 + bit3;
    } else {
        int localtmp = 0;
        #pragma unroll
        for (int j = 0; j < VSIZE; j++) {
            locals[j] = localtmp;
            int curoffset = loc + j;
            if (curoffset < N) {
                int tmp = ((input[curoffset] >> iter) & 1);
                localtmp += tmp;
            }
        }
        Pvalue += localtmp;
    }
    
    SHMEM[tx] = Pvalue;

    for (int stride = 1; stride < blockDim.x; stride *= 2) {
        __syncthreads();
        int temp = 0;
        if (tx >= stride) {
            temp = SHMEM[tx - stride];
        }
        __syncthreads(); 
        if (tx >= stride) {
            SHMEM[tx] += temp;
        }
    }
    
    __syncthreads();
    if (loc >= N) return;

    int prev = tx > 0 ? SHMEM[tx - 1]: 0;
    int dst0 = prev + locals[0];
    int dst1 = prev + locals[1];
    int dst2 = prev + locals[2];
    int dst3 = prev + locals[3];

    int4 dsts = {dst0, dst1, dst2, dst3};
    *reinterpret_cast<int4*>(&bits[loc]) = dsts;

    if (tx == 0) {
        int total_ones = SHMEM[blockDim.x - 1];
        prebits[blockIdx.x] = total_ones;
    }
}

__global__ void sort_kernel(unsigned int* prebits, int N) {
    __shared__ unsigned int SHMEM_TOTALS[WARP_SIZE];
    
    unsigned int running_total = 0; 
    int lane = threadIdx.x % WARP_SIZE;
    int warp_idx = threadIdx.x / WARP_SIZE;
    
    for (int i = 0; i < N; i += SORT_TILE_SIZE) {
        int tx = i + threadIdx.x;
        unsigned int val = 0;
        
        if (tx < N) val = prebits[tx];

        for (int s = 1; s < WARP_SIZE; s *= 2) {
            unsigned int temp = __shfl_up_sync(0xFFFFFFFF, val, s);
            if (lane >= s) val += temp; 
        }

        if (lane == WARP_SIZE - 1) {
            SHMEM_TOTALS[warp_idx] = val;
        }
        
        __syncthreads(); 

        if (warp_idx == 0) {
            int cur_value = SHMEM_TOTALS[threadIdx.x];
            for (int s = 1; s < WARP_SIZE; s *= 2) {
                unsigned int temp = __shfl_up_sync(0xFFFFFFFF, cur_value, s);
                if (lane >= s) cur_value += temp;
            }
            SHMEM_TOTALS[threadIdx.x] = cur_value;
        }
        
        __syncthreads();

        unsigned int write_val = val + running_total;
        
        if (warp_idx > 0) {
            write_val += SHMEM_TOTALS[warp_idx - 1];
        }
        
        if (tx < N) prebits[tx] = write_val;
        
        running_total += SHMEM_TOTALS[WARP_SIZE - 1];
        __syncthreads();
    }
}

__global__ void set_outputs(
    const unsigned int* input, unsigned int* output,
    unsigned int* prebits, unsigned int* bits, int prebit_size,
    int N, int iter) {
    
    int i = blockDim.x * blockIdx.x + threadIdx.x;
    int prefix_blk = i / (TILE_SIZE * VSIZE);
    
    if (i < N) {
        unsigned int value = input[i];
        unsigned int curbits = bits[i];
        unsigned int priors = prefix_blk > 0 ? prebits[prefix_blk - 1]: 0;
        int total_ones = prebits[prebit_size - 1];
        
        if ((value >> iter) & 1) {
            int dst = N - total_ones + curbits + priors;
            output[dst] = value;
        } else {
            int dst = i - priors - curbits;
            output[dst] = value;
        }
    }
}

extern "C" void solve(const unsigned int* input, unsigned int* output, int N) {
    int coarse = TILE_SIZE * VSIZE;
    int blocks = (N + coarse - 1) / coarse;
    int outblocks = (N + TILE_SIZE - 1) / TILE_SIZE;

    unsigned int *bits, *prebits;
    cudaMalloc(&bits, sizeof(unsigned int) * (N + VSIZE));
    cudaMalloc(&prebits, sizeof(unsigned int) * (blocks + WARP_SIZE));
    
    unsigned int *d_temp;
    cudaMalloc(&d_temp, sizeof(unsigned int) * N);
    cudaMemcpy(d_temp, input, sizeof(unsigned int) * N, cudaMemcpyDeviceToDevice);
    
    cudaMemset(prebits, 0, sizeof(unsigned int) * (blocks + WARP_SIZE));

    for (int i = 0; i < 32; i++) {
        const unsigned int* curInput = (i & 1) ? output : d_temp;
        unsigned int* curOutput = (i & 1) ? d_temp : output;
        radix_sort_kernel<<<blocks, TILE_SIZE>>>(curInput, bits, prebits, N, i);
        sort_kernel<<<1, SORT_TILE_SIZE>>>(prebits, blocks);
        set_outputs<<<outblocks, TILE_SIZE>>>(curInput, curOutput, prebits, bits, blocks, N, i);
    }
    
    
    cudaMemcpy(output, d_temp, sizeof(unsigned int) * N, cudaMemcpyDeviceToDevice);
    cudaDeviceSynchronize();

    cudaFree(d_temp);
    cudaFree(bits);
    cudaFree(prebits);
}



















//--------------------------------------------------------------------------------------------------
/*
question0:
ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­


è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªåŸºäº **åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰** çš„å¹¶è¡Œæ’åºç®—æ³•ï¼Œé’ˆå¯¹ 32 ä½æ— ç¬¦å·æ•´æ•°ï¼ˆ`unsigned int`ï¼‰ã€‚å®ƒé‡‡ç”¨äº†ä¸€ç§é«˜æ•ˆçš„å¤šé˜¶æ®µæ–¹æ³•ï¼ŒåŒ…æ‹¬**ä½æ”¶é›† (Bit Collection)**ã€**å¹¶è¡Œå‰ç¼€å’Œ (Prefix Sum)** å’Œ**æœ€ç»ˆæ•°æ®åˆ†å‘ (Scatter)**ã€‚

æ•´ä¸ªæ’åºè¿‡ç¨‹åœ¨ GPU ä¸Šæ‰§è¡Œï¼Œåˆ©ç”¨äº† Shared Memoryã€Warp Shuffle æŒ‡ä»¤ï¼Œå¹¶é€šè¿‡ 32 è½®å¾ªç¯ï¼ˆå¯¹åº” 32 ä½ï¼‰å®Œæˆæ’åºã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒæ€æƒ³ä¸æ•°æ®æµ

åŸºæ•°æ’åºçš„æ ¸å¿ƒåœ¨äºï¼š**å¯¹æ¯ä¸€ä½ (bit) è¿›è¡Œç¨³å®šæ’åº**ã€‚è¿™é‡Œçš„ç®—æ³•é€šè¿‡è®¡ç®—æ¯ä¸ª Block ä¸­è¯¥ä½ä¸º 1 çš„å…ƒç´ çš„æ€»æ•°ï¼Œå¹¶ä½¿ç”¨å‰ç¼€å’Œæ¥ç¡®å®šæ¯ä¸ªå…ƒç´ æœ€ç»ˆçš„ä½ç½®ã€‚

### 1\. å®å®šä¹‰

  * VSIZE_ = 4: å‘é‡åŒ–åŠ è½½å°ºå¯¸ (ä¸€æ¬¡å¤„ç† 4 ä¸ªå…ƒç´ )ã€‚
  * TILE_SIZE_ = 512: `radix_sort_kernel` ä½¿ç”¨çš„ Block çº¿ç¨‹æ•°ã€‚
  * SORT_TILE_SIZE_ = 1024: `sort_kernel` ä½¿ç”¨çš„ Block çº¿ç¨‹æ•°ã€‚

### 2\. ä¸‰ä¸ªä¸»è¦ Kernel çš„ä½œç”¨

| Kernel | ä½œç”¨ | æ ¸å¿ƒè¾“å‡º |
| :--- | :--- | :--- |
| **`radix_sort_kernel`** | **ä½æ”¶é›†å’Œå—å†…å‰ç¼€å’Œã€‚** è®¡ç®—æ¯ä¸ª Block å†…å½“å‰ä½ä¸º 1 çš„å…ƒç´ æ•°é‡ï¼Œå¹¶è®¡ç®—è¿™äº› 1 çš„**ç›¸å¯¹ä½ç½®**ã€‚ | bits æ•°ç»„ (ç›¸å¯¹ä½ç½®)ï¼›prebits æ•°ç»„ (Block æ€»å’Œ)ã€‚ |
| **`sort_kernel`** | **å…¨å±€å‰ç¼€å’Œã€‚** å¯¹æ‰€æœ‰ Block çš„æ€»å’Œ (prebits) è¿›è¡Œå¹¶è¡Œå‰ç¼€æ±‚å’Œã€‚ | æ›´æ–° prebits æ•°ç»„ (å…¨å±€ä½ç½®åç§»)ã€‚ |
| **`set_outputs`** | **æ•°æ®åˆ†å‘ã€‚** æ ¹æ®å‰ä¸¤æ­¥è®¡ç®—å‡ºçš„ä½ç½®ï¼Œå°†æ•°æ®ä»æºæ•°ç»„ (input) ç§»åŠ¨åˆ°ç›®æ ‡æ•°ç»„ (output)ã€‚ | output æ•°ç»„ (æŒ‰å½“å‰ä½æ’åº)ã€‚ |

-----

## ğŸš€ II. é˜¶æ®µ 1ï¼šä½æ”¶é›†ä¸å—å†…å½’çº¦ (`radix_sort_kernel`)

è¿™ä¸ª Kernel è´Ÿè´£å¤„ç†å½“å‰ä½ (ç”± `iter` å†³å®š) çš„ä¿¡æ¯ï¼Œå¹¶è®¡ç®— Block å†…çš„**å‰ç¼€å’Œ**ã€‚

### 1\. åˆå§‹åŠ è½½ä¸ä½å€¼è®¡ç®—

c
// ...
if (within) { // å¯¹é½æƒ…å†µ (loc + VSIZE <= N)
    const int4 *ptr = reinterpret_cast<const int4*>(&input[loc]);
    const int4 val = ptr[0];
    int bit0 = ((val.x >> iter) & 1); // æå–ç¬¬ iter ä½çš„å€¼ (0 æˆ– 1)
    // ...
    locals[0] = 0;
    locals[1] = bit0;
    locals[2] = bit0 + bit1;
    // ...
    Pvalue = bit0 + bit1 + bit2 + bit3; // çº¿ç¨‹å¤„ç†çš„ 4 ä¸ªå…ƒç´ ä¸­ï¼Œ1 çš„æ€»æ•°
_ 
// ... (éå¯¹é½å¤„ç†ç±»ä¼¼)


  * **ç›®æ ‡:** çº¿ç¨‹ tx è´Ÿè´£å¤„ç† VSIZE_=4 ä¸ªå…ƒç´ ã€‚å®ƒæå–è¿™äº›å…ƒç´ çš„ç¬¬ `iter` ä½ï¼Œå¹¶è®¡ç®—ä¸¤ä¸ªå€¼ï¼š
    1.  Pvalue: è¿™ 4 ä¸ªå…ƒç´ ä¸­**ä½å€¼ä¸º 1 çš„æ€»æ•°**ã€‚
    2.  locals: è¿™ 4 ä¸ªå…ƒç´ å†…éƒ¨çš„**ç›¸å¯¹å‰ç¼€å’Œ**ã€‚
  * **ç¤ºä¾‹ (Pvalue):** å‡è®¾ `val = {5, 6, 3, 10_`ï¼Œ`iter = 1`ã€‚
      * bit0 (5/0101) = 0; bit1 (6/0110) = 1; bit2 (3/0011) = 1; bit3 (10/1010) = 0.
      * Pvalue_ = 0 + 1 + 1 + 0 = 2ã€‚

### 2\. å—å†…å‰ç¼€å’Œ (Block-Internal Scan)

c
SHMEM[tx] = Pvalue;
for (int stride = 1; stride < blockDim.x; stride *= 2) {
    // ... å¹¶è¡Œå½’çº¦ (Parallel Reduction) ...
_


  * **å½’çº¦:** è¿™æ®µä»£ç ä½¿ç”¨æ ‡å‡†çš„ **Brent-Kung / Ladner-Fischer é£æ ¼çš„å¹¶è¡Œå‰ç¼€å’Œ (Scan) ç®—æ³•**ï¼Œä½†è¿™é‡Œæ˜¯ **Inclusive Scan**ã€‚
  * **ç›®æ ‡:** è®¡ç®— SHMEM æ•°ç»„çš„å‰ç¼€å’Œã€‚SHMEM[tx] æœ€ç»ˆå­˜å‚¨äº†çº¿ç¨‹ 0 åˆ°çº¿ç¨‹ tx æ‰€è´Ÿè´£çš„æ‰€æœ‰å…ƒç´ ä¸­ï¼Œä½å€¼ä¸º 1 çš„**æ€»æ•°é‡**ã€‚

### 3\. è®¡ç®—ç›®æ ‡ä½ç½® (`bits` æ•°ç»„)

c
int prev = tx > 0 ? SHMEM[tx - 1]: 0;
// ...
int dst0 = prev + locals[0]; // ...
*reinterpret_cast<int4*>(&bits[loc]) = dsts;


  * **`prev`:** çº¿ç¨‹ tx-1 çš„ SHMEM å€¼ï¼Œå³ **å‰ä¸€ä¸ªçº¿ç¨‹** åŠå…¶ä¹‹å‰æ‰€æœ‰çº¿ç¨‹çš„ Pvalue æ€»å’Œã€‚
  * **`dst0` åˆ° `dst3`:** è®¡ç®—å½“å‰çº¿ç¨‹è´Ÿè´£çš„ 4 ä¸ªå…ƒç´ åœ¨ **å½“å‰ Block å†…** çš„æœ€ç»ˆç›®æ ‡ä½ç½®ï¼ˆå¯¹äºä½å€¼ä¸º 1 çš„å…ƒç´ ï¼‰ã€‚
      * dst_ = å‰ä¸€ä¸ªçº¿ç¨‹çš„ _ 1  æ€»æ•°_ + å½“å‰å…ƒç´ åœ¨çº¿ç¨‹å†…çš„ç›¸å¯¹åç§»ã€‚
  * **è¾“å‡º bits:** bits[loc] å­˜å‚¨äº†è¿™ 4 ä¸ªå…ƒç´ åœ¨ Block å†…çš„**ç›¸å¯¹ä½ç½®**ä¿¡æ¯ã€‚

### 4\. å—æ€»å’Œè¾“å‡º

c
if (tx == 0) {
    int total_ones = SHMEM[blockDim.x - 1];
    prebits[blockIdx.x] = total_ones;
_


  * **`total_ones`:** çº¿ç¨‹å—å†…æ‰€æœ‰ 1 çš„æ€»æ•°ã€‚
  * **è¾“å‡º prebits:** å°†è¿™ä¸ª Block çš„æ€»å’Œå­˜å‚¨åˆ° prebits æ•°ç»„çš„ blockIdx.x ä½ç½®ã€‚**è¿™æ˜¯ç¬¬äºŒé˜¶æ®µçš„è¾“å…¥ã€‚**

-----

## ğŸ§­ III. é˜¶æ®µ 2ï¼šå…¨å±€å‰ç¼€å’Œ (`sort_kernel`)

è¿™ä¸ª Kernel è´Ÿè´£å¯¹æ‰€æœ‰ Block çš„æ€»å’Œ (prebits) è¿›è¡Œå¹¶è¡Œå‰ç¼€å’Œï¼Œè®¡ç®—å‡ºæ¯ä¸ª Block åœ¨**æ•´ä¸ªæ•°ç»„ä¸­**çš„å…¨å±€åç§»ã€‚

  * **è¾“å…¥:** prebits æ•°ç»„ï¼ˆåŒ…å«æ‰€æœ‰ Block çš„ 1 çš„æ€»æ•°ï¼‰ã€‚
  * **æ“ä½œ:** ä½¿ç”¨ **Warp Shuffle æŒ‡ä»¤** (`__shfl_up_sync`) è¿›è¡Œä¸¤æ¬¡æ ‘å½¢å½’çº¦ï¼Œæœ€ç»ˆå°† prebits æ•°ç»„æ›´æ–°ä¸º **å…¨å±€å‰ç¼€å’Œ**ã€‚
  * **ç»“æœ:** prebits[i] å­˜å‚¨äº† Block 0 åˆ° Block i-1 çš„ 1 çš„æ€»æ•°ï¼Œå³ Block i çš„**å…¨å±€èµ·å§‹åç§»é‡**ã€‚

-----

## ğŸ IV. é˜¶æ®µ 3ï¼šæ•°æ®åˆ†å‘ (`set_outputs`)

è¿™ä¸ª Kernel è´Ÿè´£æ ¹æ®å‰ä¸¤æ­¥è®¡ç®—å‡ºçš„ä½ç½®ä¿¡æ¯ï¼Œå°†æ•°æ®ä»æºæ•°ç»„ (`input` æˆ– `d_temp`) ç§»åŠ¨åˆ°ç›®æ ‡æ•°ç»„ (`output` æˆ– `d_temp`)ã€‚

c
if (i < N) {
    // ...
    unsigned int priors = prefix_blk > 0 ? prebits[prefix_blk - 1]: 0; // å…¨å±€åç§»
    int total_ones = prebits[prebit_size - 1]; // æ€»çš„ 1 çš„æ•°é‡
    
    if ((value >> iter) & 1) { // å¦‚æœå½“å‰ä½ä¸º 1
        int dst = N - total_ones + curbits + priors;
        output[dst] = value; // å†™å…¥ååŠéƒ¨åˆ† (1 çš„åŒºåŸŸ)
    _ else { // å¦‚æœå½“å‰ä½ä¸º 0
        int dst = i - priors - curbits;
        output[dst] = value; // å†™å…¥å‰åŠéƒ¨åˆ† (0 çš„åŒºåŸŸ)
    _
_


  * **priors:** å½“å‰ Block ä¹‹å‰æ‰€æœ‰ Block ä¸­ **1 çš„æ€»æ•°**ï¼ˆæ¥è‡ª prebitsï¼‰ã€‚è¿™æ˜¯ Block çš„å…¨å±€èµ·å§‹åç§»ã€‚
  * **1 çš„åˆ†é… (ååŠéƒ¨åˆ†):** N_ - total_ones ç¡®å®šäº† 1 å…ƒç´ åŒºåŸŸçš„èµ·å§‹ç‚¹ã€‚å†åŠ ä¸Š priorsï¼ˆBlock é—´çš„åç§»ï¼‰å’Œ curbitsï¼ˆBlock å†…çš„åç§»ï¼‰ï¼Œç¡®å®šå…¶åœ¨ output æ•°ç»„ä¸­çš„æœ€ç»ˆä½ç½®ã€‚
  * **0 çš„åˆ†é… (å‰åŠéƒ¨åˆ†):** 0 å…ƒç´ è¢«åˆ†é…åˆ°æ•°ç»„çš„å‰åŠéƒ¨åˆ†ã€‚å®ƒçš„ç›®æ ‡åœ°å€æ˜¯ï¼šåŸå§‹ç´¢å¼• i å‡å» 0 ä¹‹å‰çš„æ‰€æœ‰ 1 çš„æ•°é‡ã€‚

-----

## ğŸŒ V. ä¸»æœºç«¯ (`solve` å‡½æ•°)

`solve` å‡½æ•°è´Ÿè´£é©±åŠ¨æ•´ä¸ª 32 è½®çš„æ’åºè¿‡ç¨‹ï¼š

1.  **åŒç¼“å†²:** ä½¿ç”¨ `d_temp` å’Œ `output` ä½œä¸ºåŒç¼“å†²ï¼Œé€šè¿‡ `(i & 1)` åˆ‡æ¢è¾“å…¥/è¾“å‡ºæŒ‡é’ˆï¼Œé¿å…åœ¨åŒä¸€æ•°ç»„ä¸Šè¯»å†™ã€‚
2.  **ä¸»å¾ªç¯:** å¾ªç¯ 32 æ¬¡ï¼Œæ¯æ¬¡å¤„ç†ä¸€ä¸ªä½ (i ä» 0 åˆ° 31)ã€‚
3.  **æœ€ç»ˆæ‹·è´:** å¾ªç¯ç»“æŸåï¼Œå¦‚æœ `d_temp` ä¸­å­˜å‚¨äº†æœ€ç»ˆç»“æœï¼Œåˆ™å°†å…¶æ‹·è´åˆ°æœ€ç»ˆè¾“å‡º `output`ã€‚

**æ€»ç»“:** è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„å¹¶è¡ŒåŸºæ•°æ’åºå®ç°ï¼Œåˆ©ç”¨äº† CUDA çš„å¤šçº§å¹¶è¡Œæ€§ã€ç¡¬ä»¶æŒ‡ä»¤å’ŒåŒç¼“å†²æŠ€æœ¯ã€‚

//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question1:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

    unsigned int *bits, *prebits;
    cudaMalloc(&bits, sizeof(unsigned int) * (N + VSIZE));
    cudaMalloc(&prebits, sizeof(unsigned int) * (blocks + WARP_SIZE));


è¿™ä¸¤è¡Œä»£ç æ˜¯ä¸»æœºç«¯ (CPU) ä»£ç ï¼Œç”¨äºåœ¨ **GPU æ˜¾å­˜ä¸­åˆ†é…å†…å­˜**ï¼Œä»¥å­˜å‚¨åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰ç®—æ³•åœ¨æ¯ä¸€è½®è¿­ä»£ä¸­äº§ç”Ÿçš„**ä¸­é—´ç»Ÿè®¡æ•°æ®**å’Œ**å…¨å±€åç§»é‡**ã€‚

è¿™é‡Œåˆ†é…çš„å†…å­˜æ¯”å®é™…æ‰€éœ€çš„æ•°æ®é‡ç¨å¤§ï¼Œè¿™æ˜¯ CUDA ç¼–ç¨‹ä¸­å¸¸è§çš„ **å®‰å…¨å¡«å…… (Padding)** åšæ³•ï¼Œä»¥é¿å…è¾¹ç•Œé—®é¢˜å’Œå†…å­˜è®¿é—®å†²çªã€‚

---

## âš™ï¸ I. æ ¸å¿ƒå‡½æ•°ï¼š`cudaMalloc`

* **ä½œç”¨:** åœ¨ GPU çš„å…¨å±€å†…å­˜ (Global Memory) ä¸Šåˆ†é…æŒ‡å®šå¤§å°çš„å­—èŠ‚ç©ºé—´ã€‚
* **è¿”å›å€¼:** åˆ†é…ç©ºé—´çš„èµ·å§‹åœ°å€è¢«å­˜å‚¨åœ¨æŒ‡é’ˆ (`bits` æˆ– `prebits`) ä¸­ã€‚

---

## ğŸš€ II. bits æ•°ç»„çš„åˆ†é…

cudaMalloc_(\&bits, sizeof(unsigned\ int)_ * (N + VSIZE));

### 1. bits æ•°ç»„çš„ä½œç”¨

åœ¨ `radix_sort_kernel` ä¸­ï¼Œbits æ•°ç»„ç”¨äºå­˜å‚¨**æ¯ä¸ªå…ƒç´ **åœ¨å…¶æ‰€å± Block å†…çš„**ç›¸å¯¹ç›®æ ‡ä½ç½®**ã€‚

### 2. N (æ•°æ®æ€»æ•°)

* **N:** æ•´ä¸ªæ•°æ®é›†çš„å…ƒç´ æ€»æ•°ã€‚bits æ•°ç»„å¿…é¡»è‡³å°‘æœ‰ N ä¸ªå…ƒç´ æ¥å­˜å‚¨æ‰€æœ‰æ•°æ®çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚

### 3. + VSIZE (å®‰å…¨å¡«å……)

* **VSIZE** = 4 (å‘é‡åŒ–å¤§å°)ã€‚
* **ç›®çš„:** è¿™æ˜¯ä¸ºäº†**å®‰å…¨å¡«å…… (Safety Padding)**ã€‚ç”±äº Kernel ä½¿ç”¨å‘é‡åŒ– (`int4`) è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”åœ¨æ•°ç»„å°¾éƒ¨å¤„ç†éå¯¹é½çš„æ•°æ®æ—¶ï¼Œçº¿ç¨‹å¯èƒ½ä¼šå°è¯•è®¿é—® N ä¹‹åçš„å‡ ä¸ªåœ°å€ã€‚åŠ ä¸Š VSIZE å¯ä»¥ä¿è¯å³ä½¿åœ¨æ•°ç»„æœ«å°¾è¿›è¡Œå‘é‡åŒ–è¯»å†™ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´è¶Šç•Œè®¿é—®å’Œç¨‹åºå´©æºƒã€‚

> **ç¤ºä¾‹:** å¦‚æœ N=1000ã€‚
> åˆ†é…çš„å…ƒç´ æ•° = 1000 + 4 = 1004 ä¸ª `unsigned int`ã€‚

---

## ğŸ§­ III. prebits æ•°ç»„çš„åˆ†é…

cudaMalloc_(\&prebits, sizeof(unsigned\ int)_ * (blocks_ + WARP_SIZE_));

### 1. prebits æ•°ç»„çš„ä½œç”¨

prebits æ•°ç»„ç”¨äºå­˜å‚¨æ¯ä¸ª Block ä¸­ä½å€¼ä¸º 1 çš„å…ƒç´ æ€»æ•°ï¼Œç„¶åè¢« `sort_kernel` æ›´æ–°ä¸º **å…¨å±€å‰ç¼€å’Œ (Global Prefix Sum)**ã€‚

### 2. blocks (çº¿ç¨‹å—æ€»æ•°)

* **blocks:** æ•´ä¸ª Grid çš„çº¿ç¨‹å—æ€»æ•°ã€‚prebits æ•°ç»„éœ€è¦è‡³å°‘ blocks ä¸ªä½ç½®æ¥å­˜å‚¨æ¯ä¸ª Block çš„ç»Ÿè®¡ç»“æœã€‚

### 3. + WARP_SIZE (å®‰å…¨å¡«å……/å½’çº¦å¡«å……)

* **WARP_SIZE** = 32ã€‚
* **ç›®çš„:** è¿™æ˜¯ä¸º **å½’çº¦ (Reduction)** æ“ä½œè¿›è¡Œå¡«å……ã€‚`sort_kernel` å¯¹ prebits æ•°ç»„è¿›è¡Œå¹¶è¡Œå‰ç¼€æ±‚å’Œã€‚åœ¨ GPU ä¸Šï¼Œå¹¶è¡Œå½’çº¦é€šå¸¸è¦æ±‚è¾“å…¥æ•°ç»„çš„å¤§å°æ˜¯ **Warp Size (32)** çš„å€æ•°ï¼Œæˆ–è€…è‡³å°‘è¦ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´ç»™æœ€åä¸€ä¸ª Warp è¿›è¡Œè®¡ç®—ã€‚åŠ ä¸Š WARP_SIZE å¯ä»¥ç¡®ä¿å³ä½¿ blocks ä¸æ˜¯ 32 çš„å€æ•°ï¼Œå½’çº¦ Kernel ä¹Ÿèƒ½å®‰å…¨é«˜æ•ˆåœ°è¿è¡Œï¼Œé¿å…è®¿é—®è¶Šç•Œã€‚

> **ç¤ºä¾‹:** å‡è®¾ N=10000ï¼ŒTILE_SIZE * VSIZE = 512 * 4 = 2048ã€‚
> * blocks_ = ceil_(10000 / 2048) = 5 ä¸ª Blockã€‚
> * åˆ†é…çš„å…ƒç´ æ•° = 5 + 32 = 37 ä¸ª `unsigned int`ã€‚

**æ€»ç»“:** è¿™ä¸¤è¡Œä»£ç åˆ†é…äº†ç®—æ³•æ‰€éœ€çš„ä¸­é—´ç¼“å†²åŒºï¼Œå¹¶åŠ å…¥äº†å…³é”®çš„ VSIZE å’Œ WARP_SIZE å¡«å……ï¼Œè¿™æ˜¯ GPU ä¼˜åŒ–ä¸­ä¿è¯æ€§èƒ½å’Œé¿å…è¿è¡Œæ—¶é”™è¯¯çš„å¿…è¦æ­¥éª¤ã€‚

//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question2:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

    unsigned int *d_temp;
    cudaMalloc(&d_temp, sizeof(unsigned int) * N);
    cudaMemcpy(d_temp, input, sizeof(unsigned int) * N, cudaMemcpyDeviceToDevice);


è¿™æ®µä»£ç æ˜¯ä¸»æœºç«¯ (CPU) ä»£ç ï¼Œç”¨äºåœ¨ GPU æ˜¾å­˜ä¸­åˆ›å»ºä¸€ä¸ª **ä¸´æ—¶å‰¯æœ¬** æ¥å­˜å‚¨åŸå§‹è¾“å…¥æ•°æ®ï¼Œè¿™æ˜¯å®ç° **åŒç¼“å†²ï¼ˆDouble Bufferingï¼‰** æ’åºçš„å…³é”®æ­¥éª¤ã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒæ“ä½œå’Œç›®çš„

è¿™æ®µä»£ç æ‰§è¡Œäº†ä¸¤ä¸ªæ­¥éª¤ï¼š**åˆ†é…å†…å­˜** å’Œ **æ•°æ®å¤åˆ¶**ã€‚

### 1\. å£°æ˜æŒ‡é’ˆå’Œåˆ†é…å†…å­˜ (`cudaMalloc`)

c
unsigned int *d_temp;
cudaMalloc(&d_temp, sizeof(unsigned int) * N);


  * **`d_temp`:** å£°æ˜ä¸€ä¸ª GPU æŒ‡é’ˆï¼ˆ`d_` è¡¨ç¤º Deviceï¼‰ã€‚
  * **`cudaMalloc`:** åœ¨ GPU çš„å…¨å±€å†…å­˜ (Global Memory) ä¸­ï¼Œåˆ†é…äº†è¶³å¤Ÿå­˜å‚¨ N ä¸ª `unsigned int` å…ƒç´ çš„ç©ºé—´ã€‚
  * **ç”¨é€”:** d_temp å°†ä½œä¸ºåŸºæ•°æ’åºç®—æ³•ä¸­ **æ•°æ®äº¤æ¢** çš„ä¸€ä¸ªä¸´æ—¶ç¼“å†²åŒºã€‚

### 2\. æ•°æ®å¤åˆ¶ (`cudaMemcpy`)

c
cudaMemcpy(d_temp, input, sizeof(unsigned int) * N, cudaMemcpyDeviceToDevice);


  * **`cudaMemcpy`:** æ‰§è¡Œ GPU å†…éƒ¨çš„æ•°æ®æ‹·è´ã€‚
  * **æº (`input`):** åŸå§‹çš„è¾“å…¥æ•°ç»„ï¼ˆå·²åœ¨ GPU æ˜¾å­˜ä¸­ï¼‰ã€‚
  * **ç›®æ ‡ (`d_temp`):** åˆšåˆšåˆ†é…çš„ä¸´æ—¶æ˜¾å­˜ç©ºé—´ã€‚
  * **`cudaMemcpyDeviceToDevice`:** æŒ‡å®šæ‹·è´æ–¹å‘ä¸º **GPU æ˜¾å­˜åˆ° GPU æ˜¾å­˜**ã€‚

-----

## ğŸš€ II. ç¤ºä¾‹è§£é‡Šï¼šåŒç¼“å†²åœ¨æ’åºä¸­çš„ä½œç”¨

### ä¸ºä»€ä¹ˆè¦åˆ›å»ºå‰¯æœ¬ (`d_temp`)ï¼Ÿ

åŸºæ•°æ’åºæ˜¯ä¸€ä¸ª **å°±åœ°æ’åºï¼ˆIn-Place Sortï¼‰** çš„å˜ä½“ã€‚å®ƒéœ€è¦ **32 è½®** è¿­ä»£ï¼Œåœ¨æ¯ä¸€è½®ä¸­ï¼Œæ•°æ®éƒ½ä¼šæ ¹æ®å½“å‰ä½çš„å€¼ï¼ˆ0 æˆ– 1ï¼‰è¢«é‡æ–°æ’åˆ—ã€‚

å¦‚æœåªä½¿ç”¨ä¸€ä¸ªæ•°ç»„è¿›è¡Œè¯»å†™ï¼Œé‚£ä¹ˆåœ¨åŒä¸€è½®ä¸­ï¼Œçº¿ç¨‹è¯»å–æ—§æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šåŒæ—¶è¢«å…¶ä»–çº¿ç¨‹å†™å…¥æ–°æ•°æ®ï¼Œå¯¼è‡´ **æ•°æ®ç«äº‰å’ŒæŸå**ã€‚

### åŒç¼“å†²æœºåˆ¶

ä»£ç ä½¿ç”¨ `d_temp` å’Œ `output` ä¸¤ä¸ªæ•°ç»„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

| è½®æ¬¡ (i) | å¥‡å¶æ€§ (i & 1) | è§’è‰²åˆ†é… | åŠ¨ä½œ |
| :--- | :--- | :--- | :--- |
| **0 (èµ·å§‹)** | 0 (å¶æ•°) | curInput_ = d_temp, curOutput_ = output | ä» d_temp è¯»å–æ•°æ®ï¼Œå°†æ’åºç»“æœå†™å…¥ outputã€‚ |
| **1** | 1 (å¥‡æ•°) | curInput_ = output, curOutput_ = d_temp | ä» output è¯»å–ä¸Šæ¬¡ç»“æœï¼Œå°†æ’åºç»“æœå†™å…¥ d_tempã€‚ |
| **2** | 0 (å¶æ•°) | curInput_ = d_temp, curOutput_ = output | ä» d_temp è¯»å–ä¸Šæ¬¡ç»“æœï¼Œå°†æ’åºç»“æœå†™å…¥ outputã€‚ |

**æ€»ç»“ï¼š**

`d_temp` å……å½“äº†æ•°æ®äº¤æ¢çš„ä¹’ä¹“ç¼“å†²åŒºçš„**ä¸€ç«¯**ã€‚å®ƒç¡®ä¿åœ¨ä»»ä½•ä¸€ä¸ª Kernel (`radix_sort_kernel` æˆ– `set_outputs`) è¿è¡Œæ—¶ï¼Œçº¿ç¨‹è¯»å–çš„**æºæ•°ç»„**å’Œå†™å…¥çš„**ç›®æ ‡æ•°ç»„**æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä¿è¯äº†æ’åºçš„**ç¨³å®šæ€§**å’Œ**çº¿ç¨‹å®‰å…¨**ã€‚


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question3:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

    for (int i = 0; i < 32; i++) {
        const unsigned int* curInput = (i & 1) ? output : d_temp;
        unsigned int* curOutput = (i & 1) ? d_temp : output;
        radix_sort_kernel<<<blocks, TILE_SIZE>>>(curInput, bits, prebits, N, i);
        sort_kernel<<<1, SORT_TILE_SIZE>>>(prebits, blocks);
        set_outputs<<<outblocks, TILE_SIZE>>>(curInput, curOutput, prebits, bits, blocks, N, i);
    _


è¿™æ®µä»£ç æ˜¯ **åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰** ç®—æ³•çš„ **32 è½®ä¸»å¾ªç¯**ï¼Œå®ƒæ§åˆ¶ç€æ•´ä¸ªæ’åºæµç¨‹çš„è¿­ä»£å’Œæ•°æ®çš„äº¤æ¢ã€‚

æ ¸å¿ƒæœºåˆ¶æ˜¯ï¼šåˆ©ç”¨ **åŒç¼“å†² (Double Buffering)** ç­–ç•¥ï¼Œåœ¨æ¯ä¸€è½®è¿­ä»£ä¸­ï¼Œæ•°æ®åœ¨ä¸¤ä¸ª GPU å†…å­˜åŒºåŸŸ (d_temp å’Œ output) ä¹‹é—´äº¤æ›¿è¾“å…¥å’Œè¾“å‡ºã€‚

-----

## âš™ï¸ I. ä¸»å¾ªç¯ç»“æ„ä¸ç›®çš„

### 1\. å¾ªç¯æ§åˆ¶

c
for (int i = 0; i < 32; i++) {
    // ...
    // ... N, i); // 'i' is the current bit being sorted (0 to 31)
_


  * **ç›®çš„:** `unsigned int` æ˜¯ 32 ä½çš„ã€‚åŸºæ•°æ’åºå¿…é¡»å¯¹æ¯ä¸€ä¸ªä½è¿›è¡Œä¸€æ¬¡ç¨³å®šçš„æ’åºã€‚å› æ­¤ï¼Œå¾ªç¯æ‰§è¡Œ 32 æ¬¡ï¼Œå˜é‡ i ä»£è¡¨å½“å‰æ­£åœ¨å¤„ç†çš„ä½ï¼ˆä»æœ€ä½ä½ 0 åˆ°æœ€é«˜ä½ 31ï¼‰ã€‚

### 2\. åŒç¼“å†² (Ping-Pong) æœºåˆ¶

è¿™ä¸¤è¡Œä»£ç å†³å®šäº†å½“å‰è½®æ¬¡çš„è¾“å…¥å’Œè¾“å‡ºç¼“å†²åŒºï¼š

c
const unsigned int* curInput = (i & 1) ? output : d_temp;
unsigned int* curOutput = (i & 1) ? d_temp : output;


  * **`i & 1`:** è¿™æ˜¯ä¸€ä¸ªä½æ“ä½œï¼Œç”¨äºæ£€æŸ¥ i çš„**å¥‡å¶æ€§**ã€‚
      * å¦‚æœ i æ˜¯**å¶æ•°**ï¼ˆ0, 2, 4, ...ï¼‰ï¼šç»“æœä¸º 0 (False)ã€‚
      * å¦‚æœ i æ˜¯**å¥‡æ•°**ï¼ˆ1, 3, 5, ...ï¼‰ï¼šç»“æœä¸º 1 (True)ã€‚

| è½®æ¬¡ (i) | å¥‡å¶æ€§ (i & 1) | curInput (æº) | curOutput (ç›®æ ‡) | ä½œç”¨ |
| :--- | :--- | :--- | :--- | :--- |
| **0 (èµ·å§‹)** | 0 (å¶æ•°) | d_temp | output | **è¯» d_tempï¼Œå†™ output** |
| **1** | 1 (å¥‡æ•°) | output | d_temp | **è¯» outputï¼Œå†™ d_temp** |
| **2** | 0 (å¶æ•°) | d_temp | output | **è¯» d_tempï¼Œå†™ output** |
| **...** | ... | ... | ... | **äº¤æ›¿è¿›è¡Œ 32 è½®** |

> **ç›®çš„:** ç¡®ä¿åœ¨ä»»ä½•ä¸€è½®æ’åºä¸­ï¼Œçº¿ç¨‹è¯»å–çš„**æºæ•°æ®** (curInput) å’Œå†™å…¥çš„**ç›®æ ‡æ•°æ®** (curOutput) å§‹ç»ˆæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å†…å­˜åŒºåŸŸï¼Œä»è€Œé¿å…æ•°æ®ç«äº‰å’Œè¦†å†™ã€‚

-----

## ğŸš€ II. ä¸‰é˜¶æ®µæ’åºæµç¨‹

åœ¨æ¯æ¬¡å¾ªç¯è¿­ä»£ä¸­ï¼Œéƒ½ä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‰ä¸ª Kernelï¼š

### 1\. é˜¶æ®µ 1: ä½æ”¶é›† (`radix_sort_kernel`)

c
radix_sort_kernel<<<blocks, TILE_SIZE>>>(curInput, bits, prebits, N, i);


  * **è¾“å…¥:** curInput (å½“å‰æœªæ’åºçš„æ•°æ®)ã€‚
  * **è¾“å‡º:** ç»Ÿè®¡ç»“æœåˆ° bits (å—å†…ç›¸å¯¹ä½ç½®) å’Œ prebits (å—æ€»å’Œ)ã€‚
  * **ä½œç”¨:** è®¡ç®—æ¯ä¸ª Block ä¸­ï¼Œå½“å‰ä½ i ä¸º 1 çš„å…ƒç´ æ•°é‡ï¼Œå¹¶ä¸ºä¸‹ä¸€é˜¶æ®µå‡†å¤‡è¾“å…¥ã€‚

### 2\. é˜¶æ®µ 2: å…¨å±€å‰ç¼€å’Œ (`sort_kernel`)

c
sort_kernel<<<1, SORT_TILE_SIZE>>>(prebits, blocks);


  * **è¾“å…¥:** prebits (å„ Block çš„ 1 çš„æ€»æ•°)ã€‚
  * **è¾“å‡º:** æ›´æ–° prebits ä¸º**å…¨å±€å‰ç¼€å’Œ**ã€‚
  * **ä½œç”¨:** ç¡®å®šæ¯ä¸ª Block åœ¨æœ€ç»ˆæ’åºæ•°ç»„ä¸­çš„**å…¨å±€åç§»é‡**ã€‚è¿™ä¸ª Kernel åªå¯åŠ¨ 1 ä¸ª Blockï¼Œå› ä¸º prebits æ•°ç»„é€šå¸¸å¾ˆå°ã€‚

### 3\. é˜¶æ®µ 3: æ•°æ®åˆ†å‘ (`set_outputs`)

c
set_outputs<<<outblocks, TILE_SIZE>>>(curInput, curOutput, prebits, bits, blocks, N, i);


  * **è¾“å…¥:** curInput (åŸå§‹å€¼), prebits (å…¨å±€åç§»), bits (ç›¸å¯¹ä½ç½®)ã€‚
  * **è¾“å‡º:** curOutput (å½“å‰ä½æ’åºåçš„æ•°æ®)ã€‚
  * **ä½œç”¨:** æ ¹æ® prebits å’Œ bits æä¾›çš„ä½ç½®ä¿¡æ¯ï¼Œå°† curInput ä¸­çš„å…ƒç´ ç§»åŠ¨åˆ° curOutput ä¸­çš„æœ€ç»ˆä½ç½®ï¼ˆ0 åœ¨å‰ï¼Œ1 åœ¨åï¼‰ã€‚

-----

## ğŸ III. æœ€ç»ˆç»“æœ (å¾ªç¯ä¹‹å)

å¾ªç¯ç»“æŸåï¼Œæ•°æ®äº¤æ›¿å­˜å‚¨äº† 32 æ¬¡ã€‚

c
cudaMemcpy(output, d_temp, sizeof(unsigned int) * N, cudaMemcpyDeviceToDevice);


  * **æœ€ç»ˆæ£€æŸ¥:** å¦‚æœ i_=31ï¼ˆæœ€åä¸€æ¬¡è¿­ä»£ï¼‰æ˜¯å¥‡æ•°ï¼Œç»“æœåœ¨ d_temp ä¸­ï¼›å¦‚æœæ˜¯å¶æ•°ï¼Œç»“æœåœ¨ output ä¸­ã€‚
  * **æœ€ç»ˆæ‹·è´:** è¿™è¡Œä»£ç ç¡®ä¿æœ€ç»ˆæ’åºå®Œæˆçš„æ•°æ®ï¼ˆæ— è®ºå®ƒåœ¨ d_temp è¿˜æ˜¯ output ä¸­ï¼‰éƒ½è¢«æ‹·è´åˆ°**æœ€ç»ˆçš„è¾“å‡ºæŒ‡é’ˆ** output ä¸­ï¼Œå¹¶é‡Šæ”¾æ‰€æœ‰ä¸´æ—¶å†…å­˜ã€‚



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question4:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

__global__ void radix_sort_kernel(
    const unsigned int* input, unsigned int* bits, unsigned int* prebits,
    int N, int iter
) {
_


æ„Ÿè°¢æ‚¨çš„ç»†è‡´æŒ‡æ­£ã€‚æ ¹æ®æ‚¨æä¾›çš„**æ­£ç¡®ç»“æœ**ï¼ˆæ•°å€¼ 10 çš„ç¬¬ 1 ä½æ˜¯ 1ï¼‰ï¼Œæˆ‘å°†é‡æ–°è®¡ç®— Pvalue å’Œ locals æ•°ç»„ï¼Œå¹¶æ›´æ­£ç¤ºä¾‹åˆ†æã€‚

---

## âš™ï¸ I. ä¿®æ­£åçš„ä½æå–ç»“æœ

| å…ƒç´  | æ•°å€¼ (F) | 32 ä½äºŒè¿›åˆ¶ | ç¬¬ 1 ä½ (iter_=1) | **ä¿®æ­£åçš„ bit å€¼** |
| :--- | :--- | :--- | :--- | :--- |
| val.x | 5 | 010_1 | 0 | bit0_ = 0 |
| val.y | 6 | 011_0 | 1 | bit1_ = 1 |
| val.z | 3 | 001_1 | 1 | bit2_ = 1 |
| val.w | 10 | 101_0 | 1 | bit3_ = 1 |

---

## ğŸš€ II. ä¿®æ­£åçš„è®¡ç®—ç»“æœ

æˆ‘ä»¬å°†ä½¿ç”¨æ–°çš„ä½å€¼ \{0, 1, 1, 1\_ æ¥è®¡ç®— Pvalue å’Œ localsã€‚

### 1. ä¿®æ­£ Pvalue (æ€»æ•°)

Pvalue_ = bit0_ + bit1_ + bit2_ + bit3

Pvalue_ = 0 + 1 + 1 + 1 = 3

> **ä¿®æ­£å«ä¹‰ï¼š** çº¿ç¨‹ tx=1 è´Ÿè´£çš„ 4 ä¸ªå…ƒç´ ä¸­ï¼Œæœ‰ **3 ä¸ª** å…ƒç´ çš„å½“å‰ä½æ˜¯ 1ã€‚

### 2. ä¿®æ­£ locals (å†…éƒ¨å‰ç¼€å’Œ)

locals_[j] å­˜å‚¨çš„æ˜¯**åœ¨è¯¥å…ƒç´ ä¹‹å‰**æœ‰å¤šå°‘ä¸ª 1ã€‚

| ç´¢å¼• j | ä»£ç  | ç´¯åŠ é¡¹ | **ä¿®æ­£åçš„ locals_[j]** | å«ä¹‰ (ç›¸å¯¹ä½ç½®) |
| :--- | :--- | :--- | :--- | :--- |
| **0** | `locals[0] = 0;` | 0 | **0** | å…ƒç´  x ä¹‹å‰æœ‰ 0 ä¸ª 1ã€‚ |
| **1** | `locals[1] = bit0;` | 0 | **0** | å…ƒç´  y ä¹‹å‰æœ‰ 0 ä¸ª 1 (æ¥è‡ª x)ã€‚ |
| **2** | `locals[2] = bit0 + bit1;` | 0 + 1 | **1** | å…ƒç´  z ä¹‹å‰æœ‰ 1 ä¸ª 1 (æ¥è‡ª x, y)ã€‚ |
| **3** | `locals[3] = bit0 + bit1 + bit2;` | 0 + 1 + 1 | **2** | å…ƒç´  w ä¹‹å‰æœ‰ 2 ä¸ª 1 (æ¥è‡ª x, y, z)ã€‚ |

---

## ğŸ¯ ä¿®æ­£åçš„æ€»ç»“

* **ä¿®æ­£åçš„ Pvalue**ï¼š3
* **ä¿®æ­£åçš„ locals**ï¼š[0_, 0_, 1_, 2_]

**ç”¨é€”:**

1.  **Pvalue = 3** ä¼šè¢«å†™å…¥ SHMEM[tx]ï¼Œå‚ä¸ Block å†…çš„å‰ç¼€æ±‚å’Œã€‚
2.  locals_ = [0, 0, 1, 2] ä¼šåœ¨æœ€ç»ˆçš„ dst è®¡ç®—ä¸­ï¼ˆä¾‹å¦‚ dst3_ = prev_ + locals_[3]ï¼‰å‘æŒ¥ä½œç”¨ï¼Œç¡®ä¿ val.w (æ•°å€¼ 10) è¢«æ”¾ç½®åœ¨**çº¿ç¨‹ä¹‹å‰æ‰€æœ‰ 1 çš„æ•°é‡**åŠ ä¸Š **2** çš„ä½ç½®ï¼Œä¿è¯äº† 10 åœ¨ 6 å’Œ 3 ä¹‹åã€‚


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question5:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

    if (within) {
    _ else {
        int localtmp = 0;
        #pragma unroll
        for (int j = 0; j < VSIZE; j++) {
            locals[j] = localtmp;
            int curoffset = loc + j;
            if (curoffset < N) {
                int tmp = ((input[curoffset] >> iter) & 1);
                localtmp += tmp;
            _
        _
        Pvalue += localtmp;
    _


    è¿™æ®µä»£ç å¤„ç†çš„æ˜¯ **å¹¶è¡ŒåŸºæ•°æ’åº (Parallel Radix Sort)** ä¸­ï¼Œ**çº¿ç¨‹å—æœ«å°¾çš„éå¯¹é½ï¼ˆUnalignedï¼‰æ•°æ®**çš„åŠ è½½å’Œä½ç»Ÿè®¡ã€‚

ç”±äºæ— æ³•è¿›è¡Œé«˜æ•ˆçš„å‘é‡åŒ–è¯»å–ï¼ˆå› ä¸ºæ•°ç»„åœ¨ N å¤„ç»“æŸäº†ï¼‰ï¼Œä»£ç å¿…é¡»ä½¿ç”¨å®‰å…¨çš„**é€å…ƒç´  (element-by-element)** å¾ªç¯æ¥å¤„ç†å°¾éƒ¨ã€‚

-----

## âš™ï¸ I. é—®é¢˜çš„æ ¸å¿ƒï¼šéå¯¹é½æ•°æ®

### 1\. æ¡ä»¶åˆ¤æ–­

åœ¨ Kernel å¼€å§‹éƒ¨åˆ†æœ‰ï¼š

c
bool within = (loc + VSIZE) <= N;
if (within) {  ... å‘é‡åŒ–å®‰å…¨åŠ è½½ ...  _ 
else {  ... é€å…ƒç´ å®‰å…¨åŠ è½½ ...  _


  * **`within = (loc + VSIZE) <= N`**: æ£€æŸ¥å½“å‰çº¿ç¨‹è´Ÿè´£çš„ 4 ä¸ªå…ƒç´  (VSIZE_=4) æ˜¯å¦éƒ½åœ¨æ•°æ®é›† N çš„æœ‰æ•ˆèŒƒå›´å†…ã€‚
  * **`else` åˆ†æ”¯ï¼ˆæ‚¨é—®çš„ä»£ç ï¼‰ï¼š** å½“ loc_ + 4 > N æ—¶æ‰§è¡Œã€‚è¿™è¡¨æ˜å½“å‰çº¿ç¨‹çš„ 4 ä¸ªå…ƒç´ ä¸­ï¼Œè‡³å°‘æœ‰ 1 ä¸ªæˆ–å¤šä¸ªè¶…å‡ºäº†æ•°æ®é›†çš„æœ«å°¾ã€‚

### 2\. ç›®æ ‡

åœ¨ else åˆ†æ”¯ä¸­ï¼Œçº¿ç¨‹å¿…é¡»ï¼š

1.  **å®‰å…¨åœ°**è¯»å– N è¾¹ç•Œå†…çš„æœ‰æ•ˆå…ƒç´ ã€‚
2.  å¯¹**æœ‰æ•ˆå…ƒç´ **è®¡ç®—ä½å€¼ï¼ˆ0 æˆ– 1ï¼‰ã€‚
3.  è®¡ç®— locals æ•°ç»„ï¼ˆå†…éƒ¨å‰ç¼€å’Œï¼‰ã€‚
4.  è®¡ç®— Pvalue (æœ‰æ•ˆå…ƒç´ ä¸­ 1 çš„æ€»æ•°)ã€‚

-----

## ğŸ”¢ II. æ‰§è¡Œæµç¨‹ä¸ç¤ºä¾‹

å‡è®¾å‚æ•°ï¼šVSIZE_=4ï¼ŒN_=10ã€‚

å‡è®¾çº¿ç¨‹ tx è¢«åˆ†é…åˆ°çš„èµ·å§‹ç´¢å¼•æ˜¯ loc_=8ã€‚

  * **æ£€æŸ¥:** loc_ + VSIZE_ = 8 + 4 = 12ã€‚ç”±äº 12 > N=10ï¼Œæ¡ä»¶ `within` ä¸º Falseï¼Œæ‰§è¡Œ else åˆ†æ”¯ã€‚
  * **å¾…å¤„ç†çš„å…¨å±€ç´¢å¼•:** 8, 9, 10, 11ã€‚
  * **æœ‰æ•ˆç´¢å¼•:** 8, 9ã€‚

### çº¿ç¨‹ tx çš„å¾ªç¯æ‰§è¡Œ

c
int localtmp = 0; // ç´¯ç§¯å½“å‰çº¿ç¨‹çš„ 1 çš„æ€»æ•° (Pvalue çš„ç»„æˆéƒ¨åˆ†)
#pragma unroll
for (int j = 0; j < VSIZE; j++) {
    locals[j] = localtmp; // å­˜å‚¨å‰ç¼€å’Œ
    int curoffset = loc + j; // å½“å‰è¦æ£€æŸ¥çš„å…¨å±€ç´¢å¼•
    if (curoffset < N) {
        // å®‰å…¨åœ°ä»å…¨å±€å†…å­˜è¯»å–å¹¶æå–ä½å€¼
        int tmp = ((input[curoffset] >> iter) & 1); 
        localtmp += tmp;
    _
_
Pvalue += localtmp;


æˆ‘ä»¬è·Ÿè¸ªçº¿ç¨‹ tx å¤„ç† A çŸ©é˜µçš„ç¬¬ 1 ä½ (iter_=1)ï¼š

| å¾ªç¯ j | curoffset (8 + j) | è¾¹ç•Œæ£€æŸ¥ (< 10)? | æå–ä½å€¼ tmp | localtmp ç´¯åŠ  | locals[j] èµ‹å€¼ (æ—§ localtmp) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **0** | 8 | True | å‡è®¾ tmp_=0 | 0 + 0 = 0 | locals[0]_ = 0 |
| **1** | 9 | True | å‡è®¾ tmp_=1 | 0 + 1 = 1 | locals[1]_ = 0 |
| **2** | 10 | **False** | --- | 1 (ä¸å˜) | locals[2]_ = 1 |
| **3** | 11 | **False** | --- | 1 (ä¸å˜) | locals[3]_ = 1 |

### ç»“æœæ€»ç»“

1.  **localtmp / Pvalue:** æœ€ç»ˆ localtmp_=1ã€‚ Pvalue å¢åŠ  1ã€‚

      * **å«ä¹‰:** è¯¥çº¿ç¨‹åªå¤„ç†äº†ç´¢å¼• 8 å’Œ 9ï¼Œå…¶ä¸­åªæœ‰ç´¢å¼• 9 çš„å½“å‰ä½ä¸º 1ã€‚

2.  **locals æ•°ç»„:** locals_ = [0_, 0_, 1_, 1_]ã€‚

      * **å«ä¹‰:** è¿™å°±æ˜¯è¯¥çº¿ç¨‹å†…éƒ¨çš„ç›¸å¯¹å‰ç¼€å’Œï¼Œå°½ç®¡ j=2 å’Œ j=3 å¯¹åº”çš„å…ƒç´ ä¸å­˜åœ¨ï¼Œä½† locals ä»ç„¶è¢«æ­£ç¡®è®¡ç®—ï¼Œå¹¶åæ˜ äº†å‰ä¸¤ä¸ªæœ‰æ•ˆå…ƒç´ äº§ç”Ÿçš„ 1 çš„æ•°é‡ã€‚

-----

## ğŸ¯ ç»“è®ºï¼šé€å…ƒç´ å®‰å…¨å¤„ç†

è¿™æ®µ `else` ä»£ç å—æ˜¯ä¼˜åŒ–çš„ N ç»´è¾¹ç•Œå¤„ç†ï¼š

1.  **ç‰ºç‰²å‘é‡åŒ–:** æ”¾å¼ƒäº† int4 å‘é‡åŒ–åŠ è½½ï¼ˆå› ä¸ºå®ƒä¼šå¯¼è‡´è¶Šç•Œï¼‰ã€‚
2.  **ä¿è¯å®‰å…¨:** å¢åŠ äº† `if (curoffset < N)` æ£€æŸ¥ï¼Œç¡®ä¿åªå¯¹è¾¹ç•Œå†…çš„å…ƒç´ æ‰§è¡Œä½æå–å’Œç»Ÿè®¡ã€‚
3.  **è®¡ç®—è´¡çŒ®:** ä»ç„¶å‡†ç¡®è®¡ç®—äº† locals å’Œ Pvalueï¼Œä¿è¯äº†æ’åºçš„æ­£ç¡®æ€§ã€‚

//--------------------------------------------------------------------------------------------------




//--------------------------------------------------------------------------------------------------
/*
question6:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œæœ‰ä¾‹å­

    SHMEM[tx] = Pvalue;

    for (int stride = 1; stride < blockDim.x; stride *= 2) {
        __syncthreads();
        int temp = 0;
        if (tx >= stride) {
            temp = SHMEM[tx - stride];
        _
        __syncthreads(); 
        if (tx >= stride) {
            SHMEM[tx] += temp;
        _
    _

è¿™æ®µä»£ç æ˜¯ **å¹¶è¡Œå‰ç¼€æ±‚å’Œ (Parallel Prefix Sum)** ç®—æ³•çš„ç»å…¸å®ç°ï¼Œä¹Ÿå¸¸è¢«ç§°ä¸º **Scan æ“ä½œ**ã€‚å®ƒçš„ç›®æ ‡æ˜¯å°†çº¿ç¨‹å—å†…æ‰€æœ‰çº¿ç¨‹è®¡ç®—å‡ºçš„ Pvalueï¼ˆå±€éƒ¨ 1 çš„æ€»æ•°ï¼‰ç´¯åŠ èµ·æ¥ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ SHMEM æ•°ç»„ä¸­ã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡ï¼šå—å†…ç´¯è®¡æ€»å’Œ

  * **è¾“å…¥:** SHMEM[tx] å­˜å‚¨äº†çº¿ç¨‹ tx è´Ÿè´£çš„ 4 ä¸ªå…ƒç´ ä¸­ 1 çš„æ€»æ•° (Pvalue)ã€‚
  * **è¾“å‡º:** å½’çº¦åçš„ SHMEM[tx] å­˜å‚¨äº†çº¿ç¨‹ 0 åˆ°çº¿ç¨‹ tx **æ‰€æœ‰** Pvalue çš„ç´¯ç§¯æ€»å’Œã€‚

è¿™ä¸ªç´¯ç§¯æ€»å’Œï¼ˆå‰ç¼€å’Œï¼‰æ˜¯è®¡ç®—æ¯ä¸ªå…ƒç´ åœ¨ Block å†…æœ€ç»ˆä½ç½®çš„å…³é”®ã€‚

## ğŸ”¢ II. ç¤ºä¾‹è®¾å®š

æˆ‘ä»¬å‡è®¾ä¸€ä¸ªéå¸¸å°çš„çº¿ç¨‹å—ï¼š

  * **blockDim.x** (çº¿ç¨‹æ€»æ•°) = 8
  * **SHMEM åˆå§‹å€¼** (å³ Pvalue):

| çº¿ç¨‹ tx | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Pvalue** | 2 | 1 | 0 | 3 | 1 | 0 | 2 | 1 |

-----

## ğŸš€ III. å½’çº¦å¾ªç¯æ‰§è¡Œæµç¨‹

å¾ªç¯ä» stride_=1 å¼€å§‹ï¼Œæ¯æ¬¡åŠ å€ï¼Œç›´åˆ° blockDim.xã€‚

### 1\. stride_=1

c
__syncthreads();
if (tx >= 1) { temp = SHMEM[tx - 1]; _ // çº¿ç¨‹ 1 è¯» 0, çº¿ç¨‹ 2 è¯» 1, ...
__syncthreads(); 
if (tx >= 1) { SHMEM[tx] += temp; _


| tx | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **æ“ä½œ** | ä¿æŒ | 1 <-- 1+2=3 | 0 <-- 0+1=1 | 3 <-- 3+0=3 | 1 <-- 1+3=4 | 0 <-- 0+1=1 | 2 <-- 2+0=2 | 1 <-- 1+2=3 |
| **SHMEM** | **2** | **3** | **1** | **3** | **4** | **1** | **2** | **3** |

### 2\. stride_=2

c
__syncthreads();
if (tx >= 2) { temp = SHMEM[tx - 2]; _ // çº¿ç¨‹ 2 è¯» 0, çº¿ç¨‹ 3 è¯» 1, ...
__syncthreads(); 
if (tx >= 2) { SHMEM[tx] += temp; _


| tx | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **æ“ä½œ** | ä¿æŒ | ä¿æŒ | 1 <-- 1+2=3 | 3 <-- 3+3=6 | 4 <-- 4+1=5 | 1 <-- 1+3=4 | 2 <-- 2+4=6 | 3 <-- 3+1=4 |
| **SHMEM** | 2 | 3 | **3** | **6** | **5** | **4** | **6** | **4** |

### 3\. stride_=4

c
__syncthreads();
if (tx >= 4) { temp = SHMEM[tx - 4]; _ // çº¿ç¨‹ 4 è¯» 0, çº¿ç¨‹ 5 è¯» 1, ...
__syncthreads(); 
if (tx >= 4) { SHMEM[tx] += temp; _


| tx | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **æ“ä½œ** | ä¿æŒ | ä¿æŒ | ä¿æŒ | ä¿æŒ | 5 <-- 5+2=7 | 4 <-- 4+3=7 | 6 <-- 6+3=9 | 4 <-- 4+6=10 |
| **SHMEM** | 2 | 3 | 3 | 6 | **7** | **7** | **9** | **10** |

## ğŸ IV. æœ€ç»ˆç»“æœåˆ†æ

æœ€ç»ˆçš„ SHMEM æ•°ç»„ï¼š **[ 2, 3, 3, 6, 7, 7, 9, 10 ]**

è¿™ä¸ªæ•°ç»„æ˜¯ **Inclusive Scanï¼ˆåŒ…å«å¼æ‰«æï¼‰** çš„ç»“æœã€‚

| tx | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **åŸå§‹ Pvalue** | 2 | 1 | 0 | 3 | 1 | 0 | 2 | 1 |
| **ç´¯ç§¯å’Œ** | 2 | 3 | 3 | 6 | 7 | 7 | 9 | 10 |

  * **å«ä¹‰:** çº¿ç¨‹ tx=7 çœ‹åˆ° 10ï¼Œæ„å‘³ç€ Block å†…çš„æ€»å…±æœ‰ 10 ä¸ªå…ƒç´ çš„å½“å‰ä½æ˜¯ 1ã€‚
  * **`__syncthreads()`:** å¾ªç¯ä¸­çš„ä¸¤æ¬¡åŒæ­¥æ˜¯ä¸ºäº†ç¡®ä¿æ•°æ®ä¾èµ–æ€§ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»åœ¨ **è¯»å–** `SHMEM[tx - stride]` ä¹‹å‰ï¼Œç­‰å¾…**ä¸Šä¸€è½®çš„å†™å…¥æ“ä½œ**å®Œæˆã€‚

è¿™ä¸ªå‰ç¼€å’Œç»“æœæ˜¯è®¡ç®—æ¯ä¸ªå…ƒç´ åœ¨ Block å†…çš„æœ€ç»ˆç›®æ ‡ä½ç½®çš„å…³é”®è¾“å…¥ã€‚



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question7:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

    if (loc >= N) return;

    int prev = tx > 0 ? SHMEM[tx - 1]: 0;
    int dst0 = prev + locals[0];
    int dst1 = prev + locals[1];
    int dst2 = prev + locals[2];
    int dst3 = prev + locals[3];

    int4 dsts = {dst0, dst1, dst2, dst3_;
    *reinterpret_cast<int4*>(&bits[loc]) = dsts;

    if (tx == 0) {
        int total_ones = SHMEM[blockDim.x - 1];
        prebits[blockIdx.x] = total_ones;
    _

è¿™æ®µä»£ç æ˜¯ **å¹¶è¡ŒåŸºæ•°æ’åº** ä¸­ `radix_sort_kernel` çš„æœ€åä¸€æ­¥ï¼Œç›®çš„æ˜¯å°†è®¡ç®—å¥½çš„ **Block å†…éƒ¨ç›¸å¯¹ç›®æ ‡ä½ç½®** å†™å…¥å…¨å±€å†…å­˜ï¼Œå¹¶è¾“å‡ºè¯¥ Block çš„ **1 çš„æ€»æ•°**ã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡ï¼šè®¡ç®—æœ€ç»ˆç›¸å¯¹åç§»å’Œè¾“å‡º

è¿™æ®µä»£ç æ‰§è¡Œä¸¤ä¸ªå…³é”®ä»»åŠ¡ï¼š

1.  **è®¡ç®—ç›®æ ‡ä½ç½® (dst å˜é‡):** ç¡®å®šå½“å‰çº¿ç¨‹è´Ÿè´£çš„ 4 ä¸ªå…ƒç´ åœ¨ **Block å†…éƒ¨** æ’åºåï¼ˆ0 åœ¨å‰ï¼Œ1 åœ¨åï¼‰çš„èµ·å§‹ä½ç½®ã€‚
2.  **è¾“å‡º Block æ€»å’Œ (total_ones):** å°†è¯¥ Block ä¸­ 1 çš„æ€»æ•°å†™å…¥ prebits æ•°ç»„ï¼Œä½œä¸ºä¸‹ä¸€é˜¶æ®µï¼ˆå…¨å±€å‰ç¼€å’Œï¼‰çš„è¾“å…¥ã€‚

## ğŸ”¢ II. ç¤ºä¾‹è®¾å®šä¸å‰ç½®è®¡ç®—

æˆ‘ä»¬æ²¿ç”¨ä¹‹å‰çš„ç®€åŒ–ç¤ºä¾‹ï¼ˆVSIZE_=4, blockDim.x_=8ï¼‰ï¼š

  * **çº¿ç¨‹ tx=1 çš„å±€éƒ¨ç»“æœï¼š** locals_ = [0, 0, 1, 2] (å†…éƒ¨ç›¸å¯¹å‰ç¼€å’Œ)ã€‚
  * **Block å†…å‰ç¼€å’Œ (SHMEM æ•°ç»„)ï¼š** [2, 3, 3, 6, 7, 7, 9, 10]ã€‚

### 1\. è¾¹ç•Œæ£€æŸ¥

c
if (loc >= N) return;


  * **ä½œç”¨:** æ£€æŸ¥å½“å‰çº¿ç¨‹è´Ÿè´£çš„èµ·å§‹å…¨å±€ç´¢å¼• loc æ˜¯å¦è¶…å‡ºäº†æ•°æ®é›† N çš„èŒƒå›´ã€‚å¦‚æœè¶…å‡ºäº†ï¼Œè¯´æ˜è¯¥çº¿ç¨‹æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œåº”ç«‹å³é€€å‡ºã€‚

## ğŸš€ III. è®¡ç®— Block å†…éƒ¨çš„ç›¸å¯¹ç›®æ ‡ä½ç½®

è¿™ä¸ªè®¡ç®—ç»“åˆäº† **Block å†…çš„å‰ç¼€å’Œ** (prev) å’Œ **çº¿ç¨‹å†…éƒ¨çš„å‰ç¼€å’Œ** (locals)ã€‚

### 1\. è·å–å‰ä¸€ä¸ªçº¿ç¨‹çš„ç´¯ç§¯æ€»å’Œ (prev)

c
int prev = tx > 0 ? SHMEM[tx - 1]: 0;


  * **ç›®çš„:** prev å­˜å‚¨äº† tx-1 çº¿ç¨‹ä¹‹å‰ **æ‰€æœ‰** çº¿ç¨‹çš„ 1 çš„ç´¯ç§¯æ€»æ•°ã€‚
  * **ç¤ºä¾‹:** çº¿ç¨‹ tx=1ã€‚
      * prev_ = SHMEM[0]_ = 2ã€‚
      * **å«ä¹‰:** åœ¨çº¿ç¨‹ 1 å¼€å§‹å¤„ç†æ•°æ®ä¹‹å‰ï¼Œæ•´ä¸ª Block å·²ç»ç´¯ç§¯äº† **2 ä¸ª** ä½å€¼ä¸º 1 çš„å…ƒç´ ã€‚

### 2\. è®¡ç®— 4 ä¸ªå…ƒç´ çš„æœ€ç»ˆç›¸å¯¹åç§» (dst0 åˆ° dst3)

c
int dst0 = prev + locals[0]; // 2 + 0 = 2
int dst1 = prev + locals[1]; // 2 + 0 = 2
int dst2 = prev + locals[2]; // 2 + 1 = 3
int dst3 = prev + locals[3]; // 2 + 2 = 4


| å…ƒç´  | locals (ç›¸å¯¹åç§») | dst å€¼ | å«ä¹‰ (Block å†…ä½ç½®) |
| :--- | :--- | :--- | :--- |
| **ç¬¬ä¸€ä¸ª (dst0)** | 0 | 2 + 0 = 2 | å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 2 ä¸ª 1 ä¹‹åã€‚ |
| **ç¬¬äºŒä¸ª (dst1)** | 0 | 2 + 0 = 2 | å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 2 ä¸ª 1 ä¹‹åã€‚ |
| **ç¬¬ä¸‰ä¸ª (dst2)** | 1 | 2 + 1 = 3 | å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 3 ä¸ª 1 ä¹‹åã€‚ |
| **ç¬¬å››ä¸ª (dst3)** | 2 | 2 + 2 = 4 | å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 4 ä¸ª 1 ä¹‹åã€‚ |

> **å…³é”®ç‚¹:** dst å€¼ç»™å‡ºäº†ä¸€ä¸ªåç§»é‡ï¼Œè¿™ä¸ªåç§»é‡ä»£è¡¨ç€è¯¥å…ƒç´ åœ¨**æœ€ç»ˆçš„æ’åºæ•°ç»„**çš„ 1 åŒºåŸŸä¸­ï¼Œåº”è¯¥è¢«æ”¾ç½®çš„**èµ·å§‹ä½ç½®**ã€‚

### 3\. å†™å›ç›¸å¯¹ä½ç½® (`bits` æ•°ç»„)

c
int4 dsts = {dst0, dst1, dst2, dst3_;
*reinterpret_cast<int4*>(&bits[loc]) = dsts;


  * **ç›®çš„:** å°†çº¿ç¨‹è®¡ç®—å‡ºçš„è¿™ 4 ä¸ª **Block å†…åç§»é‡** å†™å…¥å…¨å±€ bits æ•°ç»„ã€‚
  * **ç´¢å¼•:** å†™å…¥ä½ç½®æ˜¯å½“å‰çº¿ç¨‹è´Ÿè´£çš„èµ·å§‹å…¨å±€ç´¢å¼• locã€‚
  * **ç”¨é€”:** bits æ•°ç»„æ˜¯ set_outputs Kernel çš„å…³é”®è¾“å…¥ï¼Œç”¨äºç¡®å®šæ¯ä¸ªå…ƒç´ åœ¨ Block å†…çš„å…·ä½“ä½ç½®ã€‚

-----

## ğŸ IV. è¾“å‡º Block æ€»å’Œ (`prebits` æ•°ç»„)

c
if (tx == 0) {
    int total_ones = SHMEM[blockDim.x - 1];
    prebits[blockIdx.x] = total_ones;
_


  * **`total_ones`:** çº¿ç¨‹ tx_=0 è¯»å– SHMEM æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´  (SHMEM[7]_=10)ï¼Œè¿™ä»£è¡¨ **æ•´ä¸ª Block** ä¸­ 1 çš„**æ€»æ•°é‡**ã€‚
  * **`prebits[blockIdx.x]`:** åªæœ‰çº¿ç¨‹ 0 å°†è¿™ä¸ªæ€»å’Œ (10) å†™å…¥ prebits æ•°ç»„çš„å¯¹åº”ä½ç½®ã€‚
  * **ç”¨é€”:** è¿™ä¸ªå€¼æ˜¯ä¸‹ä¸€ Kernel (`sort_kernel`) çš„è¾“å…¥ï¼Œç”¨äºè®¡ç®—æ‰€æœ‰ Block çš„**å…¨å±€å‰ç¼€å’Œ**ï¼Œä»è€Œç¡®å®šæ¯ä¸ª Block åœ¨æœ€ç»ˆæ’åºæ•°ç»„ä¸­çš„**å…¨å±€èµ·å§‹åç§»é‡**ã€‚



//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question8:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

int dst0 = prev + locals[0]; // 2 + 0 = 2
int dst1 = prev + locals[1]; // 2 + 0 = 2
int dst2 = prev + locals[2]; // 2 + 1 = 3
int dst3 = prev + locals[3]; // 2 + 2 = 4

answer:

å…ƒç´ locals (ç›¸å¯¹åç§»)dst å€¼å«ä¹‰ (Block å†…ä½ç½®)ç¬¬ä¸€ä¸ª (dst0)02 + 0 = 2å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 2 ä¸ª 1 ä¹‹åã€‚ç¬¬äºŒä¸ª (dst1)02 + 0 = 2å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 2 ä¸ª 1 ä¹‹åã€‚ç¬¬ä¸‰ä¸ª (dst2)12 + 1 = 3å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 3 ä¸ª 1 ä¹‹åã€‚ç¬¬å››ä¸ª (dst3)22 + 2 = 4å¦‚æœè¯¥å…ƒç´ ä½å€¼ä¸º 1ï¼Œå®ƒå°†æ’åœ¨ Block å†…çš„ç¬¬ 4 ä¸ª 1 ä¹‹åã€‚

æ‚¨é—®åˆ°çš„è¿™ä¸ªè®¡ç®—æ˜¯å¹¶è¡ŒåŸºæ•°æ’åºä¸­ **ç¡®å®š Block å†…éƒ¨ 1 çš„å…ƒç´ çš„æœ€ç»ˆç›®æ ‡ä½ç½®** çš„å…³é”®ä¸€æ­¥ã€‚

å®ƒè®¡ç®—çš„æ˜¯ **â€œå½“å‰å…ƒç´ å‰é¢æœ‰å¤šå°‘ä¸ªä½å€¼ä¸º 1 çš„å…ƒç´ â€**ã€‚

---

## âš™ï¸ I. å…¬å¼å’Œç›®æ ‡

**å…¬å¼æ ¸å¿ƒï¼š**
dst__j = prev_ + locals_[j]

* prev (Previous Sum): çº¿ç¨‹ tx **ä¹‹å‰**æ‰€æœ‰çº¿ç¨‹ç´¯ç§¯çš„ 1 çš„æ€»æ•°ã€‚
* locals_[j] (Local Offset): å½“å‰çº¿ç¨‹å†…ï¼Œå…ƒç´  j **ä¹‹å‰**æ‰€æœ‰å…ƒç´ çš„ 1 çš„æ€»æ•°ã€‚

**ç›®æ ‡:** å¾—åˆ°å½“å‰å…ƒç´ åœ¨å…¶æ•´ä¸ª Block å†…çš„**ç´¯ç§¯æ’å**ï¼ˆå³åœ¨ Block å†…æ‰€æœ‰ 1 çš„å…ƒç´ åºåˆ—ä¸­çš„ç´¢å¼•ï¼‰ã€‚

## ğŸ”¢ II. ç¤ºä¾‹åˆ†æ

æˆ‘ä»¬ä½¿ç”¨æ‚¨ä¹‹å‰è®¡ç®—çš„æ­£ç¡®ç»“æœï¼š

* **Block çº§åç§» (prev):** çº¿ç¨‹ tx=1 ä¹‹å‰æœ‰ 2 ä¸ª 1ã€‚
* **å±€éƒ¨åç§» (locals):** [0, 0, 1, 2]ã€‚
* **å…ƒç´  Bit å€¼** (å›é¡¾): \{0, 1, 1, 1\ï¼ˆå³ bit0_=0, bit1_=1, bit2_=1, bit3_=1ï¼‰ã€‚

---

### ç¤ºä¾‹è§£é‡Šï¼šè®¡ç®— dst å€¼

| å…ƒç´  j | locals_[j] | prev_ + locals_[j] | dst å€¼ | å«ä¹‰ï¼ˆç´¯ç§¯çš„ 1 çš„æ•°é‡ï¼‰ |
| :--- | :--- | :--- | :--- | :--- |
| **0 (bit=0)** | 0 | 2 + 0 | 2 | **æ€»æ•°ï¼š** 2ã€‚è¯¥å…ƒç´ æœ¬èº«æ˜¯ 0ï¼Œä½†å®ƒä¹‹å‰æœ‰ 2 ä¸ª 1ã€‚ |
| **1 (bit=1)** | 0 | 2 + 0 | 2 | **æ€»æ•°ï¼š** 2ã€‚è¯¥å…ƒç´ æœ¬èº«æ˜¯ 1ï¼Œä½†å®ƒ**ä¹‹å‰**æœ‰ 2 ä¸ª 1ã€‚ |
| **2 (bit=1)** | 1 | 2 + 1 | 3 | **æ€»æ•°ï¼š** 3ã€‚è¯¥å…ƒç´ **ä¹‹å‰**æœ‰ 3 ä¸ª 1 (prev=2 + locals=1)ã€‚ |
| **3 (bit=1)** | 2 | 2 + 2 | 4 | **æ€»æ•°ï¼š** 4ã€‚è¯¥å…ƒç´ **ä¹‹å‰**æœ‰ 4 ä¸ª 1 (prev=2 + locals=2)ã€‚ |

### ğŸ¯ ä¸ºä»€ä¹ˆ dst å€¼æ˜¯è¿™æ ·çš„ï¼Ÿ (ç†è§£ 1 å…ƒç´ çš„æ”¾ç½®)

æœ€ç»ˆï¼Œåªæœ‰ **ä½å€¼ä¸º 1 çš„å…ƒç´ ** ä¼šä½¿ç”¨ dst å€¼æ¥ç¡®å®šå®ƒä»¬åœ¨è¾“å‡ºæ•°ç»„ååŠéƒ¨åˆ†ï¼ˆ1 çš„åŒºåŸŸï¼‰ä¸­çš„ä½ç½®ã€‚

æˆ‘ä»¬æ¥çœ‹ **å…ƒç´  1, 2, 3**ï¼ˆå®ƒä»¬éƒ½æ˜¯ 1ï¼‰ï¼š

1.  **å…ƒç´  1** (bit=1):
    * dst1_=2ã€‚è¿™è¡¨ç¤ºåœ¨å…ƒç´  1 ä¹‹å‰ï¼Œæ€»å…±æœ‰ 2 ä¸ª 1ã€‚
    * ç”±äºå…ƒç´  1 æœ¬èº«æ˜¯ç¬¬ **3** ä¸ª 1ï¼Œå®ƒåº”è¯¥è¢«æ”¾åœ¨ç´¢å¼• 3 çš„ä½ç½®ï¼ˆå¦‚æœç´¢å¼•ä» 0 å¼€å§‹ï¼‰ã€‚
    * **å…³é”®ç‚¹:** dst ç»™å‡ºçš„æ˜¯**å®ƒå‰é¢å…ƒç´ çš„æ•°é‡**ã€‚

2.  **å…ƒç´  2** (bit=1):
    * dst2_=3ã€‚è¿™è¡¨ç¤ºåœ¨å…ƒç´  2 ä¹‹å‰ï¼Œæ€»å…±æœ‰ 3 ä¸ª 1ã€‚
    * å…ƒç´  2 æ˜¯ç¬¬ **4** ä¸ª 1ï¼Œå®ƒåº”è¯¥è¢«æ”¾åœ¨ç´¢å¼• 4 çš„ä½ç½®ã€‚

3.  **å…ƒç´  3** (bit=1):
    * dst3_=4ã€‚è¿™è¡¨ç¤ºåœ¨å…ƒç´  3 ä¹‹å‰ï¼Œæ€»å…±æœ‰ 4 ä¸ª 1ã€‚
    * å…ƒç´  3 æ˜¯ç¬¬ **5** ä¸ª 1ï¼Œå®ƒåº”è¯¥è¢«æ”¾åœ¨ç´¢å¼• 5 çš„ä½ç½®ã€‚

### æ€»ç»“

dst__j çš„å€¼è®¡ç®—äº†è¯¥å…ƒç´ åœ¨ Block å†…çš„**æ€»ç´¯ç§¯åç§»é‡**ã€‚å®ƒå°±æ˜¯ **â€œåœ¨å½“å‰ Block å†…ï¼Œä½äºè¯¥å…ƒç´ ä¹‹å‰çš„ã€æ‰€æœ‰ä½å€¼ä¸º 1 çš„å…ƒç´ çš„æ€»æ•°â€**ã€‚

åœ¨æœ€ç»ˆçš„ `set_outputs` Kernel ä¸­ï¼Œè¿™ä¸ª dst å€¼ä¼šä¸ **å…¨å±€åç§»é‡** (priors) ç›¸åŠ ï¼Œå…±åŒç¡®å®šè¯¥å…ƒç´ åœ¨æ•´ä¸ªæ’åºæ•°ç»„ä¸­çš„æœ€ç»ˆä½ç½®ã€‚

//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question9:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

__global__ void sort_kernel(unsigned int* prebits, int N) {
    
_

answer:

è¿™æ®µä»£ç å®ç°äº†åŸºæ•°æ’åºä¸­è‡³å…³é‡è¦çš„ç¬¬äºŒæ­¥ï¼š**å¯¹ Block çš„ç»Ÿè®¡ç»“æœè¿›è¡Œå¹¶è¡Œå‰ç¼€æ±‚å’Œï¼ˆParallel Prefix Sum / Scanï¼‰**ï¼Œä»è€Œè®¡ç®—å‡ºæ¯ä¸ª Block åœ¨æ•´ä¸ªæ•°ç»„ä¸­çš„**å…¨å±€åç§»é‡**ã€‚

è¯¥ Kernel çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒä½¿ç”¨çš„æ˜¯ **å±‚æ¬¡å½’çº¦ (Hierarchical Reduction)**ï¼Œç»“åˆäº† Warp Shuffle å’Œ Shared Memory æ¥å¤„ç†è¾“å…¥æ•°ç»„ prebitsã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡å’Œå‚æ•°

  * **ç›®æ ‡:** è®¡ç®—æ•°ç»„ prebits çš„**ç‹¬å å‰ç¼€å’Œï¼ˆExclusive Scanï¼‰**ï¼Œå¹¶å°†ç»“æœå†™å› prebitsã€‚
      * prebits åˆå§‹å­˜å‚¨äº†æ‰€æœ‰ Block çš„ 1 çš„æ€»æ•°ã€‚
      * å½’çº¦åï¼Œprebits_[i] å­˜å‚¨äº†æ‰€æœ‰ Block 0 åˆ° Block i-1 çš„ 1 çš„æ€»æ•°ï¼ˆå³ Block i çš„**å…¨å±€èµ·å§‹åç§»**ï¼‰ã€‚
  * **è¾“å…¥æ•°ç»„ N:** prebits æ•°ç»„çš„é•¿åº¦ï¼ˆå³ Block çš„æ€»æ•°ï¼‰ã€‚
  * **SORT_TILE_SIZE (1024):** çº¿ç¨‹å—å¤§å°ã€‚
  * **WARP_SIZE (32):** Warp å¤§å°ã€‚

-----

## ğŸš€ II. å±‚æ¬¡å½’çº¦æµç¨‹åˆ†è§£

è¯¥ Kernel ä½¿ç”¨äº†ä¸€ä¸ªå¤§å¾ªç¯æ¥åˆ†å—å¤„ç† prebits æ•°ç»„ï¼ˆå› ä¸º prebits å¯èƒ½å¾ˆé•¿ï¼‰ã€‚

### 1\. å¤–éƒ¨å¾ªç¯ä¸åŠ è½½

c
for (int i = 0; i < N; i += SORT_TILE_SIZE) {
    int tx = i + threadIdx.x; // å…¨å±€ç´¢å¼•
    unsigned int val = 0;
    if (tx < N) val = prebits[tx]; // çº¿ç¨‹åŠ è½½ prebits ä¸­çš„ä¸€ä¸ªå…ƒç´ 
    // ...
_


  * **ç›®çš„:** ç”±äº N (Block æ€»æ•°) å¯èƒ½å¾ˆå¤§ï¼Œæ¯ä¸ªçº¿ç¨‹å— (1024 çº¿ç¨‹) è´Ÿè´£å¤„ç† SORT_TILE_SIZE ä¸ª prebits å…ƒç´ ã€‚`tx` æ˜¯å½“å‰çº¿ç¨‹å¤„ç†çš„ prebits æ•°ç»„çš„å…¨å±€ç´¢å¼•ã€‚

### 2\. ç¬¬ä¸€çº§å½’çº¦ï¼šWarp å†…éƒ¨æ‰«æ (Intra-Warp Scan)

c
for (int s = 1; s < WARP_SIZE; s *= 2) {
    unsigned int temp = __shfl_up_sync(0xFFFFFFFF, val, s);
    if (lane >= s) val += temp; 
_


  * **æŒ‡ä»¤:** ä½¿ç”¨ __shfl_up_sync æ‰§è¡Œ Warp å†…éƒ¨çš„**ç‹¬å å‰ç¼€å’Œï¼ˆExclusive Scanï¼‰**ã€‚
  * **ç»“æœ:** å¾ªç¯ç»“æŸåï¼Œæ¯ä¸ªçº¿ç¨‹çš„ val å˜é‡ä¸­å­˜å‚¨äº† **è¯¥çº¿ç¨‹åœ¨ Warp å†…çš„å‰ç¼€å’Œ** (å³å®ƒä¹‹å‰æ‰€æœ‰çº¿ç¨‹çš„ prebits å€¼çš„æ€»å’Œ)ã€‚
  * **å…³é”®ç‚¹:** Warp å†…çš„æœ€åä¸€ä¸ªçº¿ç¨‹ (lane=31) çš„ val å­˜å‚¨äº†**æ•´ä¸ª Warp çš„æ€»å’Œ**ã€‚

### 3\. å…±äº«å†…å­˜å­˜å‚¨ä¸åŒæ­¥

c
if (lane == WARP_SIZE - 1) { // lane=31
    SHMEM_TOTALS[warp_idx] = val; // å°† Warp æ€»å’Œå­˜å…¥ Shared Memory
_
__syncthreads(); // ç¡®ä¿æ‰€æœ‰ Warp çš„æ€»å’Œéƒ½å·²å­˜å‚¨


### 4\. ç¬¬äºŒçº§å½’çº¦ï¼šWarp é—´æ‰«æ (Inter-Warp Scan)

c
if (warp_idx == 0) { // åªæœ‰ Warp 0 å·¥ä½œ
    // ... å†æ¬¡æ‰§è¡Œ Warp æ‰«æ ...
    SHMEM_TOTALS[threadIdx.x] = cur_value;
_
__syncthreads(); // ç¡®ä¿ Warp 0 å®Œæˆäº†å…¨å±€å½’çº¦


  * **ç›®çš„:** çº¿ç¨‹å—å†…çš„ SHMEM_TOTALS æ•°ç»„ï¼ˆåŒ…å«æ‰€æœ‰ Warp çš„æ€»å’Œï¼‰éœ€è¦ç´¯åŠ èµ·æ¥ï¼Œè®¡ç®—å‡º **å…¨å±€æ€»å’Œçš„å‰ç¼€å’Œ**ã€‚
  * **æ‰§è¡Œ:** åªæœ‰ Warp\ 0 è´Ÿè´£æ‰§è¡Œç¬¬äºŒæ¬¡æ‰«æï¼Œè¿™æ¬¡æ˜¯å¯¹ SHMEM_TOTALS æ•°ç»„è¿›è¡Œæ‰«æã€‚
  * **ç»“æœ:** SHMEM_TOTALS æ•°ç»„è¢«æ›´æ–°ä¸ºï¼šSHMEM_TOTALS_[i] å­˜å‚¨äº† Warp 0 åˆ° Warp i-1 çš„æ€»å’Œã€‚

-----

## ğŸ III. æœ€ç»ˆç»“æœå†™å›

è¿™æ˜¯å°†å±€éƒ¨ç»“æœå’Œå…¨å±€åç§»ç»“åˆèµ·æ¥ï¼Œå†™å…¥ prebits æ•°ç»„çš„å…³é”®ã€‚

c
unsigned int write_val = val + running_total;
if (warp_idx > 0) {
    write_val += SHMEM_TOTALS[warp_idx - 1]; // åŠ ä¸Šå‰é¢æ‰€æœ‰ Warp çš„æ€»å’Œ
_
if (tx < N) prebits[tx] = write_val;
running_total += SHMEM_TOTALS[WARP_SIZE - 1]; // æ›´æ–° running_total


### 1\. æœ€ç»ˆç›®æ ‡åœ°å€è®¡ç®—

write_val_ = val__{Warpå†…éƒ¨å‰ç¼€å’Œ__ + running_total_ + SHMEM_TOTALS[warp_idx - 1]

  * val: çº¿ç¨‹åœ¨ **Warp å†…éƒ¨** å·²ç»è®¡ç®—å¥½çš„å‰ç¼€å’Œã€‚
  * running_total: æ¥è‡ª**ä¹‹å‰çº¿ç¨‹å—**ï¼ˆPrevious Tilesï¼‰çš„å…¨å±€æ€»åç§»ã€‚
  * SHMEM_TOTALS[warp_idx - 1]: æ¥è‡ª **å½“å‰çº¿ç¨‹å—å†…** ä¹‹å‰æ‰€æœ‰ Warp çš„æ€»å’Œã€‚

è¿™ä¸‰éƒ¨åˆ†ç›¸åŠ ï¼Œæ„æˆäº†å½“å‰çº¿ç¨‹çš„ prebits[tx] å…ƒç´ åœ¨**æ•´ä¸ªæ•°ç»„ä¸­**çš„ç‹¬å å‰ç¼€å’Œã€‚

### 2\. æ›´æ–° running_total

  * `running_total += SHMEM_TOTALS[WARP_SIZE - 1];`ï¼šå°†å½“å‰çº¿ç¨‹å—çš„æ€»å’Œï¼ˆå­˜å‚¨åœ¨ SHMEM_TOTALS æ•°ç»„çš„æœ€åä¸€ä¸ªä½ç½®ï¼‰ç´¯åŠ åˆ° running_total ä¸­ï¼Œä¸º **ä¸‹ä¸€è½®å¤–éƒ¨å¾ªç¯**ï¼ˆä¸‹ä¸€ä¸ª SORT_TILE_SIZE åˆ†å—ï¼‰å‡†å¤‡å…¨å±€åç§»é‡ã€‚

**æ€»ç»“:** æ•´ä¸ª Kernel å°†æ‰€æœ‰ Block çš„ç»Ÿè®¡å€¼è¿›è¡Œåˆ†å—ã€åˆ†å±‚æ‰«æï¼Œæœ€ç»ˆè®¡ç®—å‡ºæ¯ä¸ª Block åœ¨å…¨å±€æ•°ç»„ä¸­çš„ç²¾ç¡®èµ·å§‹ä½ç½®ï¼Œç¡®ä¿äº† `set_outputs` Kernel èƒ½å¤Ÿæ­£ç¡®åœ°å°†æ•°æ®åˆ†å‘åˆ°ç›®æ ‡åœ°å€ã€‚



//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question10:

ä¸ç†è§£ï¼Œè¯·è§£é‡Šï¼Œç”¨ä¾‹å­

__global__ void set_outputs(

_

è¿™æ®µä»£ç æ˜¯å¹¶è¡ŒåŸºæ•°æ’åºï¼ˆRadix Sortï¼‰çš„\*\*æ•°æ®åˆ†å‘ï¼ˆScatterï¼‰\*\*é˜¶æ®µï¼Œä½äº `set_outputs` Kernel ä¸­ã€‚å®ƒçš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ ¹æ®å‰ä¸¤ä¸ª Kernelï¼ˆ`radix_sort_kernel` å’Œ `sort_kernel`ï¼‰è®¡ç®—å‡ºçš„ä½ç½®ä¿¡æ¯ï¼Œå°†å½“å‰ä½ä¸º 0 çš„å…ƒç´ ç§»åˆ°æ•°ç»„å‰åŠéƒ¨åˆ†ï¼Œå°†å½“å‰ä½ä¸º 1 çš„å…ƒç´ ç§»åˆ°æ•°ç»„ååŠéƒ¨åˆ†ã€‚

æ•´ä¸ªè¿‡ç¨‹ç¡®ä¿äº†æ’åºçš„ **ç¨³å®šæ€§**ï¼Œå³ç›¸åŒä½å€¼çš„å…ƒç´ ä¼šä¿æŒå…¶ç›¸å¯¹é¡ºåºã€‚

-----

## âš™ï¸ I. æ ¸å¿ƒç›®æ ‡å’Œè¾“å…¥æ•°æ®

  * **ç›®æ ‡:** å°† `input` æ•°ç»„æŒ‰å½“å‰ä½ (`iter` ä½) çš„å€¼ï¼Œç¨³å®šåœ°ç§»åŠ¨åˆ° `output` æ•°ç»„ä¸­ã€‚
  * **çº¿ç¨‹åˆ†å·¥:** æ¯ä¸ªçº¿ç¨‹ i è´Ÿè´£å¤„ç†ä¸€ä¸ªè¾“å…¥å…ƒç´  input[i]ã€‚

### å…³é”®è¾“å…¥ (æ¥è‡ªå‰åº Kernel)

| å˜é‡ | å«ä¹‰ | ç¤ºä¾‹å€¼ | ä½œç”¨ |
| :--- | :--- | :--- | :--- |
| bits_[i] | curbits | 1 | å…ƒç´  i åœ¨å…¶ **Block å†…** ä¹‹å‰æœ‰å¤šå°‘ä¸ª 1ã€‚ |
| prebits_[i] | priors | 10 | Block prefix_blk **ä¹‹å‰**æ‰€æœ‰ Block ä¸­ 1 çš„æ€»æ•°ï¼ˆå…¨å±€åç§»ï¼‰ã€‚ |
| prebits_[...] | total_ones | 400 | æ•´ä¸ªæ•°æ®é›† (N) ä¸­ 1 çš„æ€»æ•°ã€‚ |

-----

## ğŸš€ II. ç¤ºä¾‹è®¾å®šå’Œç´¢å¼•è®¡ç®—

å‡è®¾ï¼š

  * **N (æ€»å…ƒç´ æ•°)** = 1000
  * **total_ones (æ€» 1 çš„æ•°é‡)** = 400
  * **0 åŒºåŸŸå¤§å°:** 1000 - 400 = 600
  * **1 åŒºåŸŸèµ·å§‹ç‚¹:** ç´¢å¼• 600
  * **å½“å‰çº¿ç¨‹ i** = 500
  * **å½“å‰ Block çš„å…¨å±€åç§»** (priors) = 10 (çº¿ç¨‹ i=500 ä¹‹å‰æœ‰ 10 ä¸ª 1)
  * **å…ƒç´  i çš„å—å†…åç§»** (curbits) = 5 (å…ƒç´  i åœ¨ Block å†…ä¹‹å‰æœ‰ 5 ä¸ª 1)

### 1\. ç¡®å®š Block èº«ä»½

c
int prefix_blk = i / (TILE_SIZE * VSIZE);
unsigned int priors = prefix_blk > 0 ? prebits[prefix_blk - 1]: 0;


  * `prefix_blk`ï¼šè®¡ç®—å½“å‰çº¿ç¨‹ i å±äºå“ªä¸ª Blockã€‚
  * `priors`: ä» prebits æ•°ç»„ä¸­å–å‡ºè¯¥ Block **ä¹‹å‰**æ‰€æœ‰ 1 çš„æ€»æ•°ï¼ˆå…¨å±€åç§»é‡ï¼‰ã€‚

### 2\. æ ¸å¿ƒåˆ†å‘é€»è¾‘

ä»£ç æ£€æŸ¥ `input[i]` çš„å½“å‰ä½ (iter) æ˜¯ 1 è¿˜æ˜¯ 0ã€‚

-----

### åœºæ™¯ A: å…ƒç´ å€¼ä¸º 1 ï¼ˆç§»åˆ°æ•°ç»„ååŠæ®µï¼‰

å‡è®¾ `value = input[500]` çš„ iter ä½æ˜¯ **1**ã€‚

c
if ((value >> iter) & 1) { 
    int dst = N - total_ones + curbits + priors;
    output[dst] = value;
_


  * **å…¬å¼åˆ†è§£:** dst_ = \underbrace{(N - total_ones)__{1. 1 åŒºåŸŸçš„èµ·å§‹ç‚¹__ + \underbrace{priors__{2. Block é—´åç§»__ + \underbrace{curbits__{3. Block å†…åç§»_
  * **è®¡ç®—:** dst_ = (1000 - 400) + 10 + 5
    dst_ = 600 + 10 + 5 = 615

> **ç»“è®º:** å…ƒç´  i=500 è¢«å†™å…¥ output[615]ã€‚è¿™æ˜¯ 400 ä¸ª 1 çš„åŒºåŸŸä¸­çš„ç¬¬ 15 ä¸ªä½ç½®ï¼ˆ600 + 15ï¼‰ã€‚è¿™ä¸ªè®¡ç®—ç¡®ä¿äº†è¯¥å…ƒç´ æ’åœ¨æ‰€æœ‰ Block ä¹‹å‰ç´¯ç§¯çš„ 1 (10 ä¸ª) ä¹‹åï¼Œä»¥åŠå½“å‰ Block å†…ä¹‹å‰çš„æ‰€æœ‰ 1 (5 ä¸ª) ä¹‹åã€‚

-----

### åœºæ™¯ B: å…ƒç´ å€¼ä¸º 0 ï¼ˆç§»åˆ°æ•°ç»„å‰åŠæ®µï¼‰

å‡è®¾ `value = input[500]` çš„ iter ä½æ˜¯ **0**ã€‚

c
_ else {
    int dst = i - priors - curbits;
    output[dst] = value;
_


  * **å…¬å¼åˆ†è§£:** dst_ = \underbrace{i__{1. åŸå§‹å…¨å±€ç´¢å¼•__ - \underbrace{priors__{2. Block é—´åç§»__ - \underbrace{curbits__{3. Block å†…åç§»_
  * **ä½œç”¨:** è¿™ä¸ªå…¬å¼è®¡ç®—äº† i åœ¨ 0 åŒºåŸŸä¸­çš„**æ–°çš„ã€ç¨³å®šçš„ä½ç½®**ã€‚å®ƒå°† i ä¹‹å‰æ‰€æœ‰ä½å€¼ä¸º 1 çš„å…ƒç´ æ•°é‡å‡å»ã€‚
      * å‡å» priorsï¼šå‡å»ä¹‹å‰ Block ä¸­æ‰€æœ‰çš„ 1ã€‚
      * å‡å» curbitsï¼šå‡å»å½“å‰ Block å†…ä½äº i ä¹‹å‰çš„æ‰€æœ‰ 1ã€‚
  * **è®¡ç®—:** dst_ = 500 - 10 - 5
    dst_ = 485

> **ç»“è®º:** å…ƒç´  i=500 è¢«å†™å…¥ output[485]ã€‚è¿™æ˜¯ 600 ä¸ª 0 çš„åŒºåŸŸä¸­çš„ä¸€ä¸ªä½ç½®ã€‚è¿™ä¸ªè®¡ç®—ç¡®ä¿äº† i å…ƒç´ ä¿æŒäº†å…¶ç›¸å¯¹äºæ‰€æœ‰ 0 å…ƒç´ çš„ç¨³å®šé¡ºåºã€‚

-----

## ğŸ¯ æ€»ç»“

`set_outputs` Kernel é€šè¿‡ä½¿ç”¨ priors å’Œ curbits å®ç°äº† **ç¨³å®šåˆ†å‘**ï¼š

  * **0 å…ƒç´ ** ä½äº 0 åˆ° N_ - total_ones_ - 1 åŒºåŸŸã€‚
  * **1 å…ƒç´ ** ä½äº N_ - total_ones åˆ° N_ - 1 åŒºåŸŸã€‚

å¹¶ä¸”ï¼Œåœ¨å„è‡ªçš„åŒºåŸŸå†…ï¼Œæ‰€æœ‰å…ƒç´ çš„ **ç›¸å¯¹é¡ºåº** éƒ½è¢«ä¿ç•™äº†ï¼Œä»è€Œæ»¡è¶³äº†åŸºæ•°æ’åºå¯¹ç¨³å®šæ€§çš„è¦æ±‚ã€‚

//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question11:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question12:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question13:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question14:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question15:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question16:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question17:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question18:


//--------------------------------------------------------------------------------------------------


//--------------------------------------------------------------------------------------------------
/*
question19:


//--------------------------------------------------------------------------------------------------



//--------------------------------------------------------------------------------------------------
/*
question20:


//--------------------------------------------------------------------------------------------------
